<!DOCTYPE html>
<html lang="pt-br" dir="ltr">
<head>
  <meta charset="UTF-8">
  <title>Gerenciador de Treino</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=1.0, viewport-fit=cover">
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#007bff">
  <meta name="application-name" content="Gerenciador de Treino">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  
  <!-- iOS Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Workout App">
  <meta name="apple-mobile-web-app-status-bar" content="#007bff">
  
  <!-- Icons -->
  <link rel="manifest" href="/manifest.json" id="manifestLink" crossorigin="use-credentials">
  <script>
    // Add cache-busting to manifest in development
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      const manifestLink = document.getElementById('manifestLink');
      manifestLink.href = `/manifest.json?v=${Date.now()}`;
    }
  </script>
  
  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png">
  <link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png">
  
  <!-- Standard Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="144x144" href="/icons/icon-144x144.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512x512.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-48x48.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-48x48.png">
  
  <!-- Service Worker Registration -->
  <script>
    // Service Worker Registration - Moved to bottom of body to prevent conflicts
  </script>
  
  <!-- Splash Screen (iOS) -->
  <link href="/icons/icon-512x512.png" rel="apple-touch-startup-image">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Gerenciador de Treino">
  
  <!-- Additional splash screen sizes for different iOS devices -->
  <link rel="apple-touch-startup-image" href="icons/icon-512x512.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)">
  <link rel="apple-touch-startup-image" href="icons/icon-512x512.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)">
  <link rel="apple-touch-startup-image" href="icons/icon-512x512.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)">
  <link rel="apple-touch-startup-image" href="icons/icon-512x512.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)">
    
  <!-- Theme Color for various browsers -->
  <meta name="theme-color" content="#007bff">
  <meta name="msapplication-navbutton-color" content="#007bff">
  <meta name="msapplication-TileColor" content="#007bff">
  <meta name="msapplication-TileImage" content="/icons/icon-144x144.png">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval' 'unsafe-inline' cdnjs.cloudflare.com cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' cdnjs.cloudflare.com cdn.jsdelivr.net; script-src 'self' 'unsafe-inline' 'unsafe-eval' cdnjs.cloudflare.com cdn.jsdelivr.net; media-src *; img-src 'self' data: content:;">
  
  <!-- Preload critical resources -->
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"></noscript>
  
  <!-- Debug Panel - Commented Out 
  <style>
    #debug-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 200px;
      background: rgba(0, 0, 0, 0.9);
      color: #0f0;
      padding: 10px;
      font-family: monospace;
      font-size: 12px;
      overflow-y: auto;
      z-index: 9999;
      display: none;
      border-top: 1px solid #333;
    }
    #debug-toggle {
      position: fixed;
      bottom: 10px;
      right: 10px;
      z-index: 10000;
      padding: 5px 10px;
      background: #333;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    .log-entry {
      border-bottom: 1px solid #333;
      padding: 2px 0;
    }
    .log-timestamp {
      color: #0ff;
      margin-right: 8px;
    }
    .log-message {
      color: #0f0;
    }
    .log-warning {
      color: #ff0;
    }
    .log-error {
      color: #f00;
    }
  </style>
  <div id="debug-panel"></div>
  <button id="debug-toggle" onclick="toggleDebugPanel()">Toggle Debug</button>
  <script>
    // Debug panel functionality - Commented Out
    const debugPanel = document.getElementById('debug-panel');
    const debugToggle = document.getElementById('debug-toggle');
    
    // Always show debug panel on mobile for troubleshooting
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    let debugEnabled = false; // Disabled by default
    
    function toggleDebugPanel() {
      debugEnabled = !debugEnabled;
      debugPanel.style.display = debugEnabled ? 'block' : 'none';
      localStorage.setItem('debugEnabled', debugEnabled);
    }
    
    function addLog(message, type = 'info') {
      if (!debugEnabled) return;
      
      const now = new Date();
      const timestamp = now.toISOString().substr(11, 12);
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry log-${type}`;
      
      logEntry.innerHTML = `
        <span class="log-timestamp">[${timestamp}]</span>
        <span class="log-message">${message}</span>
      `;
      
      debugPanel.appendChild(logEntry);
      debugPanel.scrollTop = debugPanel.scrollHeight;
    }
    
    // Service worker registration (kept but without debug logging)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/service-worker.js')
          .then(function(registration) {
            console.log('ServiceWorker registration successful');
            
            // Check for updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  console.log('New content is available; please refresh.');
                }
              });
            });
          })
          .catch(function(error) {
            console.error('ServiceWorker registration failed: ', error);
          });
      });
    }
  </script>
  -->
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    /* Exercise List Toggle Styles */
    .exercise-list-container {
      margin: 20px 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .exercise-toggle {
      background: #f8f9fa;
      border: none;
      padding: 12px 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      text-align: left;
      font-size: 1.1em;
      color: #333;
      border-bottom: 1px solid #eee;
      transition: background-color 0.2s;
    }
    
    .exercise-toggle:hover {
      background: #f0f0f0;
    }
    
    .exercise-toggle i {
      transition: transform 0.3s ease;
      font-size: 0.8em;
      color: #666;
    }
    
    .exercise-toggle.collapsed i {
      transform: rotate(-90deg);
    }
    
    .exercise-list {
      list-style: none;
      margin: 0;
      padding: 0;
      max-height: 400px;
      overflow-y: auto;
      transition: max-height 0.3s ease-in-out;
    }
    
    .exercise-list.collapsed {
      max-height: 0;
      overflow: hidden;
    }
    
    .exercise-list li {
      padding: 10px 15px;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .exercise-list li:last-child {
      border-bottom: none;
    }
    
    .exercise-list li button {
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 0.8em;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .exercise-list li button:hover {
      background: #ff5252;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f4f4f4;
      color: #333;
      margin: 0;
      padding: 0;
      -webkit-text-size-adjust: 100%;
    }
    
    .container {
      max-width: 800px;
      margin: 40px auto;
      padding: 0.8em;
      background: white;
      min-height: 100vh;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    
    @media (max-width: 480px) {
      body {
        padding: 0.5em;
      }
      
      h1 {
        font-size: 1.5em;
        margin: 0.5em 0;
      }
      
      .contador-input {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .contador-input label {
        margin-bottom: 5px;
        text-align: left;
        min-width: auto;
      }
      
      .contador-input input {
        width: 100%;
        margin: 5px 0;
      }
      
      .contador-btn {
        width: 100%;
        margin: 5px 0;
      }
      
      button, input, select {
        font-size: 16px; /* Prevents iOS zoom on focus */
      }
    }
    h1, h2 {
      text-align: center;
    }
    input, select, button {
      width: 100%;
      padding: 0.8em;
      margin: 0.5em 0;
      font-size: 1em;
      box-sizing: border-box;
    }
    /* Stopwatch Styles */
    .stopwatch-container {
      text-align: center;
      margin: 20px 0;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #stopwatch {
      font-size: 2em;
      font-family: monospace;
      font-weight: bold;
      margin: 10px 0;
      color: #007BFF;
    }
    
    .stopwatch-controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 10px 0;
    }
    
    .stopwatch-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      background: #007BFF;
      color: white;
      font-size: 1.2em;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .stopwatch-btn:active {
      transform: scale(0.95);
    }
    
    #startStop {
      background: #28a745;
    }
    
    #reset {
      background: #dc3545;
    }
    
    #lap {
      background: #ffc107;
      color: #212529;
    }
    
    .laps-container {
      margin-top: 15px;
      max-height: 150px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .lap-time {
      padding: 8px;
      margin: 5px 0;
      background: #f8f9fa;
      border-radius: 4px;
      font-family: monospace;
    }
    
    button {
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    /* Base button styles */
    .action-button {
      width: 100%;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      margin: 5px 0;
      text-align: center;
      transition: all 0.2s;
      box-sizing: border-box;
      height: 42px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-weight: 500;
      text-transform: none;
      line-height: 1.2;
      white-space: nowrap;
      vertical-align: middle;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
    }
    
    /* Save Exercise Button */
    .action-button.save-exercise-btn {
      background-color: #28a745;
      color: white;
    }
    .action-button.save-exercise-btn:hover {
      background-color: #218838;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Export Buttons */
    .action-button.export-csv-btn,
    .action-button.export-html-btn,
    .action-button.add-exercise-btn,
    .action-button.start-execution-btn {
      background-color: #007bff;
      color: white;
    }
    .action-button.export-csv-btn:hover,
    .action-button.export-html-btn:hover,
    .action-button.add-exercise-btn:hover,
    .action-button.start-execution-btn:hover {
      background-color: #0056b3;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Danger Buttons */
    .action-button.end-session-btn,
    .action-button.clear-history-btn {
      background-color: #dc3545;
      color: white;
    }
    .action-button.end-session-btn:hover,
    .action-button.clear-history-btn:hover {
      background-color: #c82333;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Ensure all buttons have the same visual weight */
    button {
      font-family: inherit;
      margin: 0;
      padding: 0;
      border: none;
      background: none;
      cursor: pointer;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }
    .contadores {
      display: none;
      text-align: center;
      margin-top: 1em;
    }
    .contador-btn {
      width: 100%;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      margin: 5px 0;
      text-align: center;
      transition: all 0.2s;
      box-sizing: border-box;
      background-color: #007bff;
      color: white;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .contador-btn:hover {
      background-color: #0056b3;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .contador-input {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 10px 0;
    }
    .contador-input label {
      margin-right: 10px;
      min-width: 100px;
      text-align: right;
    }
    .contador-input input {
      width: 80px;
      text-align: center;
      margin: 0 5px;
    }
    #lista-exercicios {
      list-style: none;
      padding: 0;
    }
    #lista-exercicios li {
      padding: 0.4em;
      background: #ddd;
      margin: 0.3em 0;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
    }
    .remover {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
      padding: 0;
      flex-shrink: 0;
    }
    .remover:hover {
      background: #c82333;
    }
    
    .export-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .export-btn:first-child {
      background-color: #28a745;
    }
    
    .export-btn:first-child:hover {
      background-color: #218838;
    }
  </style>
</head>
<body>
  <!-- Message container for success/error messages -->
  <div id="mensagem" style="display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); color: white; padding: 10px 20px; border-radius: 4px; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.15);"></div>
  
  <div class="container">
  <h1>🏋️ Gerenciador de Treino</h1>
  <div class="stopwatch-container">
    <div id="stopwatch">00:00:00</div>
    <div class="stopwatch-controls">
      <button id="startStop" class="stopwatch-btn"><i class="fas fa-play"></i></button>
      <button id="reset" class="stopwatch-btn"><i class="fas fa-redo"></i></button>
      <button id="lap" class="stopwatch-btn"><i class="fas fa-flag"></i></button>
    </div>
    <div id="laps" class="laps-container"></div>
  </div>

  <!-- Seleção -->
  <form onsubmit="event.preventDefault(); iniciarTreino();">
    <div class="form-group">
      <label for="exercicio-select">Selecionar exercício:</label>
      <select id="exercicio-select" class="form-select" onchange="selecionarExercicio(this.value)">
        <option value="">-- Selecione --</option>
      </select>
    </div>
    <button type="submit" class="action-button start-execution-btn">Iniciar Execução</button>
  </form>

  <!-- Contadores -->
  <div id="contadores" class="contadores">
    <h2 id="exercicio-nome"></h2>
    
    <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin: 15px 0;">
      <button class="contador-btn" onclick="incrementar('exec')" style="width: auto; min-width: 120px;">+ Execução</button>
      <span style="font-size: 1.1em;">Execuções: <strong id="exec-count">0</strong></span>
    </div>
    
    <div class="contador-input">
      <label for="rep-count">Repetições:</label>
      <input type="number" id="rep-count" value="0" min="0" onchange="atualizarContador('rep', this.value)">
    </div>
    
    <div class="contador-input">
      <label for="carga1">Carga 1 (kg):</label>
      <input type="number" id="carga1" value="0" min="0" step="0.5" onchange="atualizarCarga('carga1', this.value)">
    </div>
    
    <div class="contador-input">
      <label for="carga2">Carga 2 (kg):</label>
      <input type="number" id="carga2" min="0" step="0.5" onchange="atualizarCarga('carga2', this.value)">
    </div>
    
    <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
      <button type="button" onclick="salvarSessao()" class="action-button save-exercise-btn">
        <i class="fas fa-save"></i> Salvar Exercício
      </button>
    </div>
    <div id="sessao-salva" style="display: none; margin: 10px 0; padding: 10px; background: #e8f5e9; color: #2e7d32; border-radius: 4px;">
      Exercício salvo com sucesso!
    </div>
  </div>
  
  <!-- Histórico de Sessões -->
  <div id="historico-container" style="margin-top: 30px;">
    <h2>Histórico de Sessões</h2>
    <div id="historico-sessoes" style="max-height: 700px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px; background: white; min-height: 60px; margin-bottom: 15px;">
      <p style="margin: 0; color: #666; font-style: italic;">Nenhuma sessão salva ainda.</p>
    </div>
    
    <div style="margin-top: 15px;">
      <div style="display: flex; flex-direction: column; gap: 10px;">
        <button class="action-button end-session-btn" onclick="finalizarSessao()" style="width: 100%;">
          <i class="fas fa-flag-checkered"></i> Finalizar Sessão
        </button>
        <div style="margin: 10px 0; border-top: 1px solid #eee;"></div>
        <button class="action-button export-csv-btn" onclick="exportarCSV()" style="width: 100%;">
          <i class="fas fa-file-csv"></i> Exportar CSV
        </button>
        <button class="action-button export-html-btn" onclick="exportarHTML()" style="width: 100%;">
          <i class="fas fa-file-code"></i> Exportar HTML
        </button>
        <button class="action-button clear-history-btn" onclick="limparHistorico()" style="width: 100%;">
          <i class="fas fa-trash-alt"></i> Limpar Histórico
        </button>
      </div>
    </div>

  <!-- Cadastro -->
  <h2>Cadastrar Novo Exercício</h2>
  <input type="text" id="novo-exercicio" placeholder="Nome do exercício">
  <button class="action-button add-exercise-btn" onclick="adicionarExercicio()">Adicionar</button>

  <!-- Lista de Exercícios -->
  <div class="exercise-list-container">
    <div class="exercise-toggle" id="exerciseListToggle" onclick="toggleExerciseList()">
      <i class="fas fa-chevron-down"></i>
      <span>Exercícios Cadastrados</span>
    </div>
    <ul id="lista-exercicios" class="exercise-list"></ul>
    <!-- Admin button for localStorage access -->
    <div style="margin-top: 40px; text-align: center;">
      <a href="localStorage.html" class="admin-button" style="
        display: inline-block;
        padding: 6px 12px;
        background-color: #f8f9fa;
        color: #6c757d;
        text-decoration: none;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        font-size: 12px;
        opacity: 0.7;
        transition: opacity 0.2s;
      ">
        <i class="fas fa-cog"></i> Admin
      </a>
    </div>
  </div>

  <script>
    let execucoes = 0;
    let repeticoes = '';
    let carga1 = '';
    let carga2 = '';
    let exercicioAtual = "";
    let dataSessao = null;
    let historicoTreino = [];

    function salvarLista(lista) {
      localStorage.setItem("exercicios", JSON.stringify(lista));
    }

    function carregarLista() {
      return JSON.parse(localStorage.getItem("exercicios")) || [];
    }

    function atualizarDropdown() {
      const select = document.getElementById("exercicio-select");
      select.innerHTML = '<option value="">-- Selecione --</option>';
      const lista = carregarLista();
      lista.forEach(ex => {
        // Ensure exercise is a string
        const exerciseName = typeof ex === 'object' ? (ex.nome || JSON.stringify(ex)) : String(ex);
        const opt = document.createElement("option");
        opt.value = exerciseName;
        opt.textContent = exerciseName;
        select.appendChild(opt);
      });
    }

    function atualizarLista() {
      const ul = document.getElementById("lista-exercicios");
      ul.innerHTML = "";
      const lista = carregarLista();
      lista.forEach((ex, i) => {
        // Ensure exercise is a string for display
        const exerciseName = typeof ex === 'object' ? (ex.nome || JSON.stringify(ex)) : String(ex);
        
        const li = document.createElement("li");
        li.textContent = exerciseName;
        
        const btn = document.createElement("button");
        btn.textContent = "x";
        btn.className = "remover";
        btn.onclick = () => {
          lista.splice(i, 1);
          // Save the cleaned list (ensuring all entries are strings)
          const cleanedList = lista.map(item => 
            typeof item === 'object' ? (item.nome || JSON.stringify(item)) : String(item)
          );
          salvarLista(cleanedList);
          atualizarLista();
          atualizarDropdown();
        };
        li.appendChild(btn);
        ul.appendChild(li);
      });
    }

    function adicionarExercicio() {
      const nome = document.getElementById("novo-exercicio").value.trim();
      if (!nome) return;
      
      // Ensure the name is a string
      const exerciseName = String(nome);
      
      const lista = carregarLista();
      
      // Check if exercise already exists (case-insensitive)
      const exists = lista.some(ex => {
        const existingName = typeof ex === 'string' ? ex : (ex.nome || JSON.stringify(ex));
        return existingName.toLowerCase() === exerciseName.toLowerCase();
      });
      
      if (!exists) {
        lista.push(exerciseName);
        salvarLista(lista);
        atualizarLista();
        atualizarDropdown();
        document.getElementById("novo-exercicio").value = "";
      } else {
        alert("Este exercício já existe na lista.");
      }
    }

    function iniciarTreino() {
      const select = document.getElementById("exercicio-select");
      let nome = select.value;
      if (!nome) return alert("Selecione um exercício.");
      
      // Ensure the name is a string and not an object
      if (typeof nome === 'object') {
        nome = nome.nome || nome.toString();
      } else {
        nome = String(nome);
      }
      
      exercicioAtual = nome;
      execucoes = 0;
      repeticoes = '';
      carga1 = '';
      carga2 = '';
      
      // Clear form
      document.getElementById('exercicio-select').value = '';
      document.getElementById("exec-count").textContent = execucoes;
      document.getElementById("rep-count").value = '';
      document.getElementById("carga1").value = '';
      document.getElementById("carga2").value = '';
      document.getElementById("exercicio-nome").textContent = nome;
      document.getElementById("contadores").style.display = "block";
      
      // Set session date/time only if not already set
      if (!dataSessao) {
        dataSessao = new Date();
      }
    }

    function incrementar(tipo) {
      if (tipo === "exec") execucoes++;
      if (tipo === "rep") repeticoes++;
      document.getElementById("exec-count").textContent = execucoes;
      document.getElementById("rep-count").value = repeticoes;
    }

    function atualizarContador(tipo, valor) {
      valor = parseInt(valor) || 0;
      if (tipo === "rep") repeticoes = valor;
      document.getElementById("rep-count").value = repeticoes;
    }
    
    function atualizarCarga(tipo, valor) {
      if (tipo === 'carga1') {
        carga1 = parseFloat(valor) || 0;
        document.getElementById("carga1").value = carga1;
      } else if (tipo === 'carga2') {
        carga2 = valor === '' ? null : parseFloat(valor);
        document.getElementById("carga2").value = carga2 === null ? '' : carga2;
      }
    }

    function salvarSessao() {
      if (!exercicioAtual) return alert("Nenhum exercício em andamento.");
      
      const dataAtual = new Date();
      const dataAtualFormatada = dataAtual.toLocaleDateString('pt-BR');
      const sessionEnded = localStorage.getItem(`sessionEnded_${dataAtualFormatada}`) === 'true';
      
      // If previous session was ended, start a new one
      if (sessionEnded) {
        // Clear the session ended flag for the current date
        localStorage.removeItem(`sessionEnded_${dataAtualFormatada}`);
        // Reset the end session button
        const endSessionBtn = document.querySelector('.finalizar-btn');
        if (endSessionBtn) {
          endSessionBtn.disabled = false;
          endSessionBtn.style.opacity = '1';
          endSessionBtn.style.cursor = 'pointer';
        }
        // Show new session started message
        const successMsg = document.getElementById('sessao-salva');
        successMsg.textContent = 'Nova sessão iniciada!';
        successMsg.style.display = 'block';
        successMsg.style.backgroundColor = '#e6f7ff';
        successMsg.style.color = '#1890ff';
        setTimeout(() => { successMsg.style.display = 'none'; }, 3000);
      }
      
      // Use the current time for the session
      const dataSessaoAtual = dataSessao || new Date();
      const dataFormatada = dataSessaoAtual.toLocaleString('pt-BR');
      
      // Generate a session ID if this is a new session
      const sessionId = sessionEnded ? Date.now().toString() : 
                        (localStorage.getItem('currentSessionId') || Date.now().toString());
      
      // Store the current session ID
      localStorage.setItem('currentSessionId', sessionId);
      
      // Ensure exercicioAtual is a string and not an object
      const exercicioNome = typeof exercicioAtual === 'object' ? 
                           (exercicioAtual.nome || exercicioAtual.toString()) : 
                           String(exercicioAtual);
      
      const sessao = {
        data: dataSessaoAtual.toISOString(),
        exercicio: exercicioNome,  // Use the properly formatted exercise name
        execucoes: execucoes,
        repeticoes: repeticoes,
        carga1: carga1,
        carga2: carga2,
        dataFormatada: dataFormatada,
        sessionId: sessionId  // Add session ID to track session boundaries
      };
      
      // Get existing sessions or initialize empty array
      const historicoSessoes = JSON.parse(localStorage.getItem("historicoSessoes")) || [];
      historicoSessoes.unshift(sessao); // Add to beginning of array to show newest first
      
      // Save to localStorage
      localStorage.setItem("historicoSessoes", JSON.stringify(historicoSessoes));
      
      // Show success message
      const successMsg = document.getElementById('sessao-salva');
      successMsg.textContent = 'Exercício salvo com sucesso!';
      successMsg.style.display = 'block';
      setTimeout(() => {
        successMsg.style.display = 'none';
      }, 3000);
      
      // Update the displayed history
      exibirHistoricoSessoes();
      
      // Reset for next exercise
      document.getElementById("exercicio-select").value = "";
      document.getElementById("contadores").style.display = "none";
      exercicioAtual = "";
      dataSessao = null; // Reset session date for next session
    }
    
    function finalizarSessao() {
      // console.log('finalizarSessao called');
      
      // Get current session ID
      const currentSessionId = localStorage.getItem('currentSessionId');
      // console.log('Current session ID:', currentSessionId);
      
      if (!currentSessionId) {
        // console.log('No active session to finalize');
        mostrarMensagem('Nenhuma sessão ativa para finalizar.', 'info');
        return;
      }
      
      // Get current sessions
      let historicoSessoes = JSON.parse(localStorage.getItem("historicoSessoes") || "[]");
      // console.log('Current history entries:', historicoSessoes.length);
      
      // Get exercises for current session
      const currentSessionExercises = historicoSessoes.filter(s => s.sessionId === currentSessionId && !s.isSessionEnd);
      // console.log('Exercises in current session:', currentSessionExercises.length);
      
      if (currentSessionExercises.length === 0) {
        // console.log('No exercises found in current session');
        mostrarMensagem('Nenhum exercício encontrado nesta sessão.', 'info');
        return;
      }
      
      // Get the first exercise for duration calculation
      const firstExercise = currentSessionExercises.reduce((earliest, current) => {
        return (!earliest || new Date(current.data) < new Date(earliest.data)) ? current : earliest;
      }, null);
      
      // Get current counts using the session's date for accurate weekly/monthly counting
      const now = new Date();
      const currentCounts = getWorkoutCounts(now);
      
      // For the first session of the week/month, use 1, otherwise increment the count
      const weeklyCount = currentCounts.weeklyCount === 0 ? 1 : currentCounts.weeklyCount + 1;
      const monthlyCount = currentCounts.monthlyCount === 0 ? 1 : currentCounts.monthlyCount + 1;
      
      // Create session end marker with historical counts
      const sessionEndMarker = {
        isSessionEnd: true,
        sessionId: currentSessionId,
        data: now.toISOString(),
        dataFormatada: now.toLocaleString('pt-BR'),
        exercicio: "",
        execucoes: 0,
        repeticoes: 0,
        duracao: firstExercise ? (now - new Date(firstExercise.data)) / 1000 : 0,
        exerciciosCount: currentSessionExercises.length,
        weeklyCount: weeklyCount,
        monthlyCount: monthlyCount
      };
      
      // Remove any existing end marker for this session
      historicoSessoes = historicoSessoes.filter(s => !(s.sessionId === currentSessionId && s.isSessionEnd));
      
      // Add the new end marker to the beginning (like exercises)
      historicoSessoes.unshift(sessionEndMarker);
      
      // Save to localStorage
      localStorage.setItem("historicoSessoes", JSON.stringify(historicoSessoes));
      
      // Mark session as ended
      const endedSessions = JSON.parse(localStorage.getItem('endedSessions') || '{}');
      endedSessions[currentSessionId] = true;
      localStorage.setItem('endedSessions', JSON.stringify(endedSessions));
      
      // Clear current session ID
      localStorage.removeItem('currentSessionId');
      
      // Reset UI
      document.getElementById("exercicio-select").value = "";
      document.getElementById("contadores").style.display = "none";
      exercicioAtual = "";
      dataSessao = null;
      
      // Show success message
      // console.log('Showing success message and updating history display');
      mostrarMensagem('Sessão finalizada com sucesso!', 'success');
      
      // Force a complete refresh of the history display
      // console.log('Calling exibirHistoricoSessoes()...');
      exibirHistoricoSessoes();
      
      // Verify the history was updated
      setTimeout(() => {
        // console.log('Verifying history update...');
        const historicoDiv = document.getElementById('historico-sessoes');
        if (historicoDiv) {
          // console.log('Scrolling to top of history');
          historicoDiv.scrollTop = 0;
          
          // Log the current state of the history div for debugging
          // console.log('History div content length:', historicoDiv.innerHTML.length);
          // console.log('First 200 chars of history:', historicoDiv.innerHTML.substring(0, 200));
        } else {
          // console.error('Historico div not found!');
        }
      }, 100);
    }
    
    function exibirHistoricoSessoes() {
      // console.log('exibirHistoricoSessoes called');
      const historicoDiv = document.getElementById("historico-sessoes");
      if (!historicoDiv) {
        // console.error('Historico div not found!');
        return;
      }
      
      const historicoSessoes = JSON.parse(localStorage.getItem("historicoSessoes")) || [];
      // console.log('Total entries in history:', historicoSessoes.length);
      // console.log('Session end markers in history:', historicoSessoes.filter(s => s.isSessionEnd).length);
      
      if (historicoSessoes.length === 0) {
        // console.log('No history entries found, showing empty message');
        historicoDiv.innerHTML = "<p style=\"margin: 0; color: #666; font-style: italic;\">Nenhuma sessão salva ainda.</p>";
        return;
      }
      
      // Group sessions by date and session ID
      // console.log('Grouping sessions by date and session ID...');
      const sessoesPorData = {};
      const endedSessions = JSON.parse(localStorage.getItem('endedSessions') || '{}');
      // console.log('Ended sessions from storage:', endedSessions);
      
      // First, group by date and session ID
      historicoSessoes.forEach((sessao, index) => {
        const dataKey = new Date(sessao.data).toLocaleDateString('pt-BR');
        const sessionId = sessao.sessionId || 'default';
        
        if (!sessoesPorData[dataKey]) {
          sessoesPorData[dataKey] = {};
        }
        if (!sessoesPorData[dataKey][sessionId]) {
          sessoesPorData[dataKey][sessionId] = [];
        }
        
        // Add index to the session for deletion
        sessao.originalIndex = index;
        sessoesPorData[dataKey][sessionId].push(sessao);
        
        if (sessao.isSessionEnd) {
          console.log(`Found session end marker for session ${sessionId} at index ${index}`, sessao);
        }
      });
      
      console.log('Grouped sessions by date:', Object.keys(sessoesPorData).length, 'dates found');
      
      let html = '';
      
      // Process each date in descending order (newest first)
      console.log('Processing dates...');
      const sortedDates = Object.entries(sessoesPorData).sort(([dateA], [dateB]) => {
        return new Date(dateB.split('/').reverse().join('-')) - new Date(dateA.split('/').reverse().join('-'));
      });
      
      for (const [data, sessionsByDate] of sortedDates) {
        console.log(`Processing date: ${data}`);
        html += `
          <div style="margin-bottom: 25px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <div style="font-weight: bold; color: #333; margin-bottom: 8px; font-size: 1.1em;">${data}</div>
            <div style="border-top: 1px solid #eee; margin: 8px 0 12px 0;"></div>
        `;
        
        // Process each session within the date
        console.log(`Processing ${Object.keys(sessionsByDate).length} sessions for date ${data}`);
        for (const [sessionId, sessoesDoDia] of Object.entries(sessionsByDate)) {
          console.log(`- Session ID: ${sessionId}, Entries: ${sessoesDoDia.length}`);
          
          // Separate exercises from session end markers
          const exercises = [];
          const endMarkers = [];
          
          // First, separate exercises and end markers
          sessoesDoDia.forEach(sessao => {
            if (sessao.isSessionEnd) {
              // console.log('  Found session end marker:', sessao);
              endMarkers.push(sessao);
            } else {
              exercises.push(sessao);
            }
          });
          
          // console.log(`  Exercises: ${exercises.length}, End markers: ${endMarkers.length}`);
          
          if (exercises.length === 0) {
            // console.log('  No exercises in this session, skipping');
            continue; // Skip if no exercises in this session
          }
          
          // Sort exercises by time (oldest first within the day)
          exercises.sort((a, b) => new Date(a.data) - new Date(b.data));
          // Sort end markers by time (newest first within the day)
          endMarkers.sort((a, b) => new Date(b.data) - new Date(a.data));
          
          // Add session start message
          const primeiraSessao = exercises[0];
          const horaInicio = new Date(primeiraSessao.data).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
          
          html += `
            <div style="margin-bottom: 15px;">
              <div style="color: #1890ff; margin-bottom: 12px; padding: 8px 12px; background-color: #e6f7ff; border-left: 3px solid #1890ff; border-radius: 2px;">
                🕒 ${horaInicio} - Sessão Iniciada
              </div>
          `;
          
          // Add exercises
          exercises.forEach((sessao) => {
            const hora = new Date(sessao.data).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            const stats = [
              `Execuções: ${sessao.execucoes}`,
              `Repetições: ${sessao.repeticoes}`
            ];
            
            // Ensure exercicio is a string
            let exercicioNome = sessao.exercicio;
            if (typeof exercicioNome === 'object') {
              exercicioNome = exercicioNome.nome || JSON.stringify(exercicioNome);
            }
            
            if (sessao.carga1 !== null && sessao.carga1 !== undefined) {
              stats.push(`Carga 1: ${sessao.carga1} kg`);
            }
            if (sessao.carga2 !== null && sessao.carga2 !== undefined) {
              stats.push(`Carga 2: ${sessao.carga2} kg`);
            }
            
            html += `
              <div style="margin: 8px 0; padding: 8px; background: white; border-radius: 4px; border: 1px solid #eee;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-weight: 500;">${hora} - ${exercicioNome}</span>
                  <button 
                    onclick="removerExercicio(${sessao.originalIndex})" 
                    style="
                      background: #ff4d4f; 
                      color: white; 
                      border: none; 
                      border-radius: 4px; 
                      width: 24px;
                      height: 24px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      cursor: pointer;
                      font-size: 16px;
                      line-height: 1;
                      padding: 0;
                      margin-left: 10px;
                      transition: background-color 0.2s;
                    "
                    onmouseover="this.style.backgroundColor='#ff7875'"
                    onmouseout="this.style.backgroundColor='#ff4d4f'"
                    title="Excluir exercício"
                  >
                    ×
                  </button>
                </div>
                <div style="margin-top: 6px; padding-left: 4px;">
                  ${stats.map((stat, i) => {
                    const isLast = i === stats.length - 1;
                    const prefix = isLast ? '└─ ' : '├─ ';
                    return `<div style="color: #666; font-size: 0.9em; margin: 2px 0;">${prefix}${stat}</div>`;
                  }).join('')}
                </div>
              </div>
            `;
          });
          
          // Add session end message if exists
          if (endMarkers.length > 0) {
            console.log('  Processing session end marker...');
            const endMarker = endMarkers[0]; // Only use the first end marker if multiple exist
            console.log('  End marker data:', endMarker);
            
            const horaFim = new Date(endMarker.data).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            
            const startTime = new Date(primeiraSessao.data);
            const endTime = new Date(endMarker.data);
            const duracaoSegundos = Math.max(1, Math.ceil((endTime - startTime) / 1000));
            const duracaoMinutos = Math.floor(duracaoSegundos / 60);
            const segundosRestantes = duracaoSegundos % 60;
            const exerciciosCount = exercises.length;
            
            console.log(`  Session duration: ${duracaoMinutos}m ${segundosRestantes}s, Exercises: ${exerciciosCount}`);
            
            // Use the historical counts that were stored when the session ended
            const weeklyCount = endMarker.weeklyCount || 1;
            const monthlyCount = endMarker.monthlyCount || 1;
            
            const sessionEndHtml = `
              <div style="margin-top: 16px; padding: 8px 12px; background-color: #f6ffed; border-left: 3px solid #52c41a; border-radius: 2px;">
                <div style="color: #52c41a; font-weight: 500;">
                  🕒 ${horaFim} - Sessão Finalizada
                </div>
                <div style="color: #8c8c8c; margin-left: 20px; font-size: 0.9em; margin-top: 4px;">
                  <div>└─ Duração: ${duracaoMinutos} minuto${duracaoMinutos !== 1 ? 's' : ''} e ${segundosRestantes} segundo${segundosRestantes !== 1 ? 's' : ''}</div>
                  <div>└─ Exercícios realizados: ${exerciciosCount}</div>
                  <div>└─ Treinos na semana: ${weeklyCount}</div>
                  <div>└─ Treinos no mês: ${monthlyCount}</div>
                </div>
              </div>
            `;
            
            console.log('  Adding session end HTML to output');
            html += sessionEndHtml;
          }
          
          // Close the session div
          html += `
            </div> <!-- End of session div -->
          `;
          
          html += `</div>`; // Close session container
        }
        
        html += `</div>`; // Close date container
      }
      
      console.log('Updating history DOM with new HTML...');
      console.log('HTML length:', html.length);
      historicoDiv.innerHTML = html;
      console.log('History DOM updated');
    }
    // Função para exibir mensagens de sucesso/erro
    function mostrarMensagem(mensagem, tipo = 'info') {
      const mensagemDiv = document.getElementById('mensagem');
      if (!mensagemDiv) return;
      
      // Definir cores com base no tipo de mensagem
      const cores = {
        success: '#52c41a',
        error: '#f5222d',
        info: '#1890ff',
        warning: '#faad14'
      };
      
      mensagemDiv.textContent = mensagem;
      mensagemDiv.style.backgroundColor = cores[tipo] || cores.info;
      mensagemDiv.style.display = 'block';
      
      // Esconder a mensagem após 3 segundos
      setTimeout(() => {
        mensagemDiv.style.display = 'none';
      }, 3000);
    }
    
    function exportarCSV() {
      const sessoes = JSON.parse(localStorage.getItem("historicoSessoes") || "[]");
      const sessoesPorData = {};
      
      // Group sessions by date and session ID
      sessoes.forEach((sessao, index) => {
        const dataKey = new Date(sessao.data).toLocaleDateString('pt-BR');
        const sessionId = sessao.sessionId || 'default';
        
        if (!sessoesPorData[dataKey]) {
          sessoesPorData[dataKey] = {};
        }
        if (!sessoesPorData[dataKey][sessionId]) {
          sessoesPorData[dataKey][sessionId] = [];
        }
        
        // Add index to the session for reference
        sessao.originalIndex = index;
        sessoesPorData[dataKey][sessionId].push(sessao);
      });
      
      if (Object.keys(sessoesPorData).length === 0) {
        return alert("Nenhuma sessão salva para exportar.");
      }
      
      // Create CSV header
      let csv = "Tipo;Data/Hora;Detalhe;Duração;Exercício;Execuções;Repetições;Carga 1 (kg);Carga 2 (kg)\n";
      
      // Process each date and session
      for (const [data, sessionsByDate] of Object.entries(sessoesPorData)) {
        for (const [sessionId, sessoesDoDia] of Object.entries(sessionsByDate)) {
          // Separate exercises from session end markers
          const exercises = sessoesDoDia.filter(s => !s.isSessionEnd);
          const endMarkers = sessoesDoDia.filter(s => s.isSessionEnd);
          
          if (exercises.length === 0) continue;
          
          // Sort by time
          exercises.sort((a, b) => new Date(a.data) - new Date(b.data));
          
          // Add session start
          const startTime = new Date(exercises[0].data);
          csv += `"Sessão Iniciada";"${startTime.toLocaleString('pt-BR')}";"Início da sessão de treino";"";"";"";"";"";""\n`;
          
          // Add exercises
          exercises.forEach(sessao => {
            const dataHora = new Date(sessao.data).toLocaleString('pt-BR');
            const carga1 = sessao.carga1 || 0;
            const carga2 = sessao.carga2 !== null && sessao.carga2 !== undefined ? sessao.carga2 : '';
            csv += `"Exercício";"${dataHora}";"${sessao.exercicio}";"";"${sessao.exercicio}";${sessao.execucoes};${sessao.repeticoes};${carga1};${carga2}\n`;
          });
          
          // Add session end if exists
          if (endMarkers.length > 0) {
            const endMarker = endMarkers[0];
            const endTime = new Date(endMarker.data);
            const duracaoSegundos = Math.max(1, Math.ceil((endTime - startTime) / 1000));
            const duracaoMinutos = Math.floor(duracaoSegundos / 60);
            const segundosRestantes = duracaoSegundos % 60;
            const duracaoFormatada = `${duracaoMinutos}:${segundosRestantes.toString().padStart(2, '0')}`;
            
            csv += `"Sessão Finalizada";"${endTime.toLocaleString('pt-BR')}";"Fim da sessão de treino";"${duracaoFormatada}";"";"${exercises.length}";"";"";""\n`;
          }
          
          // Add empty line between sessions
          csv += "\n";
        }
      }
      
      // Create and trigger download
      const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `historico_treino_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
    }
    
    function exportarHTML() {
      const sessoes = JSON.parse(localStorage.getItem('historicoSessoes') || '[]');
      const sessoesAgrupadas = {};
      
      // Group sessions by date and session ID
      sessoes.forEach((sessao, index) => {
        const dataKey = new Date(sessao.data).toLocaleDateString('pt-BR');
        const sessionId = sessao.sessionId || 'default';
        
        if (!sessoesAgrupadas[dataKey]) {
          sessoesAgrupadas[dataKey] = {};
        }
        if (!sessoesAgrupadas[dataKey][sessionId]) {
          sessoesAgrupadas[dataKey][sessionId] = [];
        }
        
        sessao.originalIndex = index;
        sessoesAgrupadas[dataKey][sessionId].push(sessao);
      });
      
      if (Object.keys(sessoesAgrupadas).length === 0) {
        alert('Nenhum dado para exportar.');
        return;
      }
      
      // Calculate dashboard metrics
      const uniqueDays = new Set();
      let totalExercises = 0;
      let totalSeconds = 0;
      
      sessoes.forEach(sessao => {
        if (sessao.isSessionEnd) return; // Skip session end markers
        
        const date = new Date(sessao.data);
        const dateString = date.toISOString().split('T')[0]; // YYYY-MM-DD format
        uniqueDays.add(dateString);
        
        totalExercises++;
        
        if (sessao.duracao) {
          totalSeconds += parseInt(sessao.duracao) || 0;
        }
      });
      
      const totalHours = (totalSeconds / 3600).toFixed(1);
      
      // Create HTML document
      let html = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <title>Histórico de Treinos</title>
        <style>
          body { 
            font-family: Arial, sans-serif; 
            line-height: 1.6; 
            color: #333; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f5f5f5;
          }
          h1 { 
            color: #1890ff; 
            text-align: center; 
            margin-bottom: 30px;
          }
          .export-date {
            text-align: right;
            color: #666;
            margin-bottom: 20px;
            font-size: 0.9em;
          }
          .dashboard {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            gap: 20px;
          }
          .stat-card {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          }
          .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #1890ff;
            margin: 10px 0;
          }
          .stat-label {
            color: #666;
            font-size: 0.9em;
          }
          .session-date { 
            font-size: 1.3em; 
            font-weight: bold; 
            margin: 30px 0 15px; 
            padding-bottom: 8px; 
            border-bottom: 2px solid #1890ff;
            color: #333;
          }
          .session { 
            margin-bottom: 30px; 
            background: white; 
            padding: 20px; 
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
          }
          .session-start { 
            color: #1890ff; 
            background-color: #e6f7ff; 
            padding: 10px 15px; 
            border-left: 4px solid #1890ff; 
            margin: 0 0 15px 0;
            border-radius: 4px;
            font-weight: 500;
          }
          .exercise { 
            margin: 15px 0; 
            padding: 12px; 
            background: white; 
            border-radius: 6px; 
            border: 1px solid #eee;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
          }
          .exercise-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 8px;
            width: 100%;
          }
          .exercise-time { 
            font-weight: bold;
            color: #666;
            font-size: 0.9em;
            margin-left: 10px;
            white-space: nowrap;
          }
          .exercise-name { 
            font-weight: 500;
            color: #1890ff;
            flex-grow: 1;
            margin-right: 10px;
          }
          .exercise-stats { 
            margin-left: 15px; 
            color: #555; 
            font-size: 0.95em;
            line-height: 1.5;
          }
          .session-end { 
            color: #52c41a; 
            background-color: #f6ffed; 
            padding: 10px 15px; 
            border-left: 4px solid #52c41a; 
            margin: 15px 0 0 0;
            border-radius: 4px;
            font-weight: 500;
          }
          .stat-line {
            margin: 4px 0;
            padding-left: 10px;
            position: relative;
          }
          .stat-line:before {
            content: "•";
            position: absolute;
            left: 0;
            color: #999;
          }
          .session-duration {
            font-weight: 500;
            color: #333;
          }
        </style>
      </head>
      <body>
        <h1>Histórico de Treinos</h1>
        <div class="export-date">Exportado em: ${new Date().toLocaleString('pt-BR')}</div>
        
        <!-- Dashboard -->
        <div class="dashboard">
          <div class="stat-card">
            <div class="stat-value">${uniqueDays.size}</div>
            <div class="stat-label">Dias Ativos</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${totalExercises}</div>
            <div class="stat-label">Exercícios</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${totalHours}</div>
            <div class="stat-label">Horas de Treino</div>
          </div>
        </div>
      `;
      
      // Sort dates in descending order (newest first)
      const datasOrdenadas = Object.keys(sessoesAgrupadas).sort((a, b) => 
        new Date(b.split('/').reverse().join('-')) - new Date(a.split('/').reverse().join('-'))
      );
      
      // Process each date
      datasOrdenadas.forEach(data => {
        html += `<div class="session-date">${data}</div>`;
        const sessoesDoDia = sessoesAgrupadas[data];
        
        // Process each session for this date
        Object.values(sessoesDoDia).forEach(sessoes => {
          if (sessoes.length === 0) return;
          
          // Separate exercises from session end markers
          const exercises = sessoes.filter(s => !s.isSessionEnd);
          const endMarkers = sessoes.filter(s => s.isSessionEnd);
          
          if (exercises.length === 0) return;
          
          // Sort by time
          exercises.sort((a, b) => new Date(a.data) - new Date(b.data));
          
          // Add session start
          const startTime = new Date(exercises[0].data);
          const formattedStartTime = startTime.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
          
          html += `
            <div class="session">
              <div class="session-start">
                🕒 ${formattedStartTime} - Sessão Iniciada
              </div>
          `;
          
          // Add exercises
          exercises.forEach(sessao => {
            const hora = new Date(sessao.data).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            const stats = [
              sessao.execucoes ? `Execuções: ${sessao.execucoes}` : null,
              sessao.repeticoes ? `Repetições: ${sessao.repeticoes}` : null,
              sessao.carga1 !== undefined ? `Carga 1: ${sessao.carga1} kg` : null,
              sessao.carga2 !== undefined && sessao.carga2 !== '' ? `Carga 2: ${sessao.carga2} kg` : null
            ].filter(Boolean);
            
            // Get the exercise name and time
            const exerciseName = sessao.exercicio;
            const exerciseTime = hora;
            
            // Check if the line starts with a time pattern and exercise name
            const timeExerciseMatch = exerciseName.match(/^(\d{2}:\d{2}:\d{2})\s+•\s+(.+)/);
            
            let displayName, displayTime;
            if (timeExerciseMatch) {
              // If the exercise name already contains a time, use that format but swap the positions
              displayTime = timeExerciseMatch[1];
              displayName = timeExerciseMatch[2];
            } else {
              // Otherwise use the separate time and name
              displayTime = exerciseTime;
              displayName = exerciseName;
            }
            
            html += `
              <div class="exercise">
                <div class="exercise-header">
                  <span class="exercise-name">${displayName}</span>
                  <span class="exercise-time">${displayTime}</span>
                </div>
                <div class="exercise-stats">
                  ${stats.map(stat => `<div class="stat-line">${stat}</div>`).join('')}
                </div>
              </div>
            `;
          });
          
          // Add session end if exists
          if (endMarkers.length > 0) {
            const endMarker = endMarkers[0];
            const endTime = new Date(endMarker.data);
            const formattedEndTime = endTime.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            
            // Calculate duration
            const duracaoSegundos = Math.max(1, Math.ceil((endTime - startTime) / 1000));
            const duracaoMinutos = Math.floor(duracaoSegundos / 60);
            const segundosRestantes = duracaoSegundos % 60;
            
            html += `
              <div class="session-end">
                <div>🕒 ${formattedEndTime} - Sessão Finalizada</div>
                <div class="exercise-stats">
                  <div class="stat-line">Duração: <span class="session-duration">${duracaoMinutos} minuto${duracaoMinutos !== 1 ? 's' : ''} e ${segundosRestantes} segundo${segundosRestantes !== 1 ? 's' : ''}</span></div>
                  <div class="stat-line">Exercícios realizados: <span class="session-duration">${exercises.length}</span></div>
                </div>
              </div>
            `;
          }
          
          html += `</div>`; // Close session div
        });
      });
      
      // Close HTML document
      html += `
        </body>
        </html>
      `;
      
      // Create and trigger download
      const blob = new Blob([html], { type: 'text/html;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `historico_treino_${new Date().toISOString().slice(0,10)}.html`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      // Stopwatch functionality
      let stopwatchInterval;
      let seconds = 0;
      let isRunning = false;
      
      function updateStopwatch() {
        seconds++;
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        document.getElementById('stopwatch').textContent = 
          `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      }
      
      document.getElementById('startStop').addEventListener('click', function() {
        if (isRunning) {
          clearInterval(stopwatchInterval);
          this.innerHTML = '<i class="fas fa-play"></i>';
        } else {
          stopwatchInterval = setInterval(updateStopwatch, 1000);
          this.innerHTML = '<i class="fas fa-pause"></i>';
        }
        isRunning = !isRunning;
      });
      
      document.getElementById('reset').addEventListener('click', function() {
        clearInterval(stopwatchInterval);
        seconds = 0;
        document.getElementById('stopwatch').textContent = '00:00:00';
        document.getElementById('startStop').innerHTML = '<i class="fas fa-play"></i>';
        document.getElementById('laps').innerHTML = '';
        isRunning = false;
      });
      
      document.getElementById('lap').addEventListener('click', function() {
        if (seconds > 0) {
          const lapTime = document.getElementById('stopwatch').textContent;
          const lapElement = document.createElement('div');
          lapElement.className = 'lap-time';
          lapElement.textContent = `Volta ${document.getElementById('laps').children.length + 1}: ${lapTime}`;
          document.getElementById('laps').prepend(lapElement);
        }
      });
      
      // Inicialização
      atualizarDropdown();
      atualizarLista();
      exibirHistoricoSessoes();
    }

    function removerExercicio(index) {
      const historicoSessoes = JSON.parse(localStorage.getItem("historicoSessoes") || "[]");
      if (index >= 0 && index < historicoSessoes.length) {
        const exerciseToRemove = historicoSessoes[index];
        const sessionId = exerciseToRemove.sessionId;
        
        if (!sessionId) {
          // If no session ID, just remove the exercise
          if (!confirm('Tem certeza que deseja excluir este exercício?')) return;
          historicoSessoes.splice(index, 1);
        } else {
          // Find all exercises in this session
          const sessionExercises = historicoSessoes.filter(s => s.sessionId === sessionId && !s.isSessionEnd);
          
          if (sessionExercises.length <= 1) {
            // If this is the last exercise, show special message and remove the entire session
            if (!confirm('Este é o último exercício da sessão. Toda a sessão será deletada junto.')) return;
            
            // Remove all entries with this sessionId
            const updatedHistorico = historicoSessoes.filter(session => {
              return !session.sessionId || session.sessionId !== sessionId;
            });
            
            // Save the updated history
            localStorage.setItem("historicoSessoes", JSON.stringify(updatedHistorico));
            
            // Update the display
            exibirHistoricoSessoes();
            
            // Show success message
            mostrarMensagem('Sessão removida com sucesso!', 'success');
            return;
          } else {
            // Remove just this exercise
            if (!confirm('Tem certeza que deseja excluir este exercício?')) return;
            historicoSessoes.splice(index, 1);
          }
        }
        
        // Save the updated history
        localStorage.setItem("historicoSessoes", JSON.stringify(historicoSessoes));
        
        // Update the display
        exibirHistoricoSessoes();
        
        // Show success message
        mostrarMensagem('Exercício removido com sucesso!', 'success');
      }
    }
    
    function removerSessao(index) {
      if (!confirm('Tem certeza que deseja excluir esta sessão?')) return;
      
      const historicoSessoes = JSON.parse(localStorage.getItem("historicoSessoes") || "[]");
      if (index >= 0 && index < historicoSessoes.length) {
        const sessionToRemove = historicoSessoes[index];
        const sessionIdToRemove = sessionToRemove.sessionId;
        
        // Remove all entries with this sessionId (both exercises and session end marker)
        const updatedHistorico = historicoSessoes.filter(session => {
          // Keep sessions that don't match the ID, or don't have an ID (legacy support)
          return !session.sessionId || session.sessionId !== sessionIdToRemove;
        });
        
        // Save the updated history
        localStorage.setItem("historicoSessoes", JSON.stringify(updatedHistorico));
        
        // Update the display
        exibirHistoricoSessoes();
        
        // Show success message
        mostrarMensagem('Sessão removida com sucesso!', 'success');
      }
    }
    
    // Get weekly and monthly workout counts based on calendar weeks/months
    function getWorkoutCounts(specificDate = null) {
      const referenceDate = specificDate ? new Date(specificDate) : new Date();
      const historicoSessoes = JSON.parse(localStorage.getItem("historicoSessoes") || "[]");
      
      // Get start of week (Sunday) for the reference date
      const startOfWeek = new Date(referenceDate);
      startOfWeek.setDate(referenceDate.getDate() - referenceDate.getDay());
      startOfWeek.setHours(0, 0, 0, 0);
      
      // Get end of week (next Saturday) for the reference date
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 6);
      endOfWeek.setHours(23, 59, 59, 999);
      
      // Get start of month for the reference date
      const startOfMonth = new Date(referenceDate.getFullYear(), referenceDate.getMonth(), 1);
      
      // Get end of month for the reference date
      const endOfMonth = new Date(referenceDate.getFullYear(), referenceDate.getMonth() + 1, 0);
      endOfMonth.setHours(23, 59, 59, 999);
      
      // Filter sessions for the current calendar week (Sunday to Saturday)
      const weekSessions = historicoSessoes.filter(sessao => {
        if (!sessao.isSessionEnd) return false;
        const sessaoDate = new Date(sessao.data);
        // Only include sessions from the current calendar week (Sunday to Saturday)
        return sessaoDate >= startOfWeek && sessaoDate <= endOfWeek;
      });
      
      // Debug: Log the dates being used for weekly filtering
      console.log('Weekly range:', startOfWeek.toLocaleString(), 'to', endOfWeek.toLocaleString());
      console.log('Sessions in week:', weekSessions.length);
      
      const monthSessions = historicoSessoes.filter(sessao => {
        if (!sessao.isSessionEnd) return false;
        const sessaoDate = new Date(sessao.data);
        return sessaoDate >= startOfMonth && sessaoDate <= endOfMonth;
      });
      
      // Count unique session IDs
      const weeklyCount = new Set(weekSessions.map(s => s.sessionId)).size;
      const monthlyCount = new Set(monthSessions.map(s => s.sessionId)).size;
      
      return { 
        weeklyCount: weeklyCount,
        monthlyCount: monthlyCount
      };
    }
    
    // Update workout counts in localStorage
    function updateWorkoutCounts() {
      const counts = getWorkoutCounts();
      localStorage.setItem('workoutCounts', JSON.stringify({
        weekly: counts.weeklyCount,
        monthly: counts.monthlyCount,
        lastUpdated: new Date().toISOString()
      }));
      return counts;
    }
    
    // Toggle exercise list function
    function toggleExerciseList() {
      const list = document.getElementById('lista-exercicios');
      const toggle = document.getElementById('exerciseListToggle');
      
      list.classList.toggle('collapsed');
      toggle.classList.toggle('collapsed');
      
      // Save state
      localStorage.setItem('exerciseListCollapsed', list.classList.contains('collapsed'));
    }
    
    // Stopwatch variables
    let isRunning = false;
    let stopwatchInterval = null;
    let seconds = 0;
    
    // Update stopwatch display
    function updateStopwatch() {
      seconds++;
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      document.getElementById('stopwatch').textContent = 
        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    
    // Initialize exercise list state
    document.addEventListener('DOMContentLoaded', function() {
      const list = document.getElementById('lista-exercicios');
      const toggle = document.getElementById('exerciseListToggle');
      
      // Load saved state
      const isCollapsed = localStorage.getItem('exerciseListCollapsed') === 'true';
      if (isCollapsed) {
        list.classList.add('collapsed');
        toggle.classList.add('collapsed');
      }
    });

    // Register Service Worker for PWA functionality
    if ('serviceWorker' in navigator) {
      const registerServiceWorker = async () => {
        try {
          console.log('[Service Worker] Starting registration process...');
          
          // Check if we're in a secure context (required for service workers)
          if (!window.isSecureContext) {
            console.warn('[Service Worker] Service workers require HTTPS (or localhost for development)');
          }
          
          // Get all registrations first
          const registrations = await navigator.serviceWorker.getRegistrations();
          
          // Unregister all existing service workers
          if (registrations.length > 0) {
            console.log(`[Service Worker] Found ${registrations.length} existing service workers, unregistering...`);
            await Promise.all(registrations.map(reg => {
              console.log(`[Service Worker] Unregistering: ${reg.scope}`);
              return reg.unregister();
            }));
            console.log('[Service Worker] All service workers unregistered');
          } else {
            console.log('[Service Worker] No existing service workers found');
          }
          
          // Clear all caches except the ones we want to keep
          try {
            console.log('[Service Worker] Clearing old caches...');
            const cacheNames = await caches.keys();
            const cacheDeletions = cacheNames.map(cacheName => {
              if (!cacheName.includes('workout-manager-v')) {
                console.log(`[Service Worker] Deleting cache: ${cacheName}`);
                return caches.delete(cacheName);
              }
              return Promise.resolve();
            });
            await Promise.all(cacheDeletions);
            console.log('[Service Worker] Old caches cleared');
          } catch (cacheError) {
            console.error('[Service Worker] Error clearing caches:', cacheError);
          }
          
          // Register the new service worker
          console.log('[Service Worker] Registering service worker...');
          const registration = await navigator.serviceWorker.register('/service-worker.js', {
            updateViaCache: 'none',
            scope: '/'
          });
          
          console.log('[Service Worker] Registration successful, scope:', registration.scope);
          
          // Handle updates
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            if (!newWorker) return;
            
            console.log('[Service Worker] New service worker found, state:', newWorker.state);
            
            newWorker.addEventListener('statechange', () => {
              console.log(`[Service Worker] State changed to: ${newWorker.state}`);
              
              // When the new worker is installed, prompt the user to update
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                console.log('[Service Worker] New content is available; refreshing...');
                // Auto-refresh to apply the update
                window.location.reload();
              }
              
              // When the new worker is activated, refresh the page
              if (newWorker.state === 'activated') {
                console.log('[Service Worker] New service worker activated');
                if (navigator.serviceWorker.controller) {
                  window.location.reload();
                }
              }
            });
          });
          
          // Handle controller changes
          let refreshing = false;
          navigator.serviceWorker.addEventListener('controllerchange', () => {
            if (!refreshing) {
              console.log('[Service Worker] Controller changed, reloading page...');
              refreshing = true;
              window.location.reload();
            }
          });
          
          // Set up message channel for communication with the service worker
          if (navigator.serviceWorker.controller) {
            const messageChannel = new MessageChannel();
            
            // Handle incoming messages from the service worker
            messageChannel.port1.onmessage = (event) => {
              console.log('[Service Worker] Message received:', event.data);
              
              // Handle specific message types
              if (event.data && event.data.type === 'REFRESH_PAGE') {
                console.log('[Service Worker] Refreshing page as requested');
                window.location.reload();
              }
            };
            
            // Send initialization message to the service worker
            navigator.serviceWorker.controller.postMessage({
              type: 'INIT',
              payload: {
                appVersion: '1.0.0',
                timestamp: new Date().toISOString()
              }
            }, [messageChannel.port2]);
          }
          
          // Set up global error handler for unhandled promise rejections
          window.addEventListener('unhandledrejection', (event) => {
            console.error('[Service Worker] Unhandled rejection:', event.reason);
          });
          
          // Check for updates every 15 minutes
          setInterval(() => {
            console.log('[Service Worker] Checking for updates...');
            registration.update().catch(err => {
              console.error('[Service Worker] Update check failed:', err);
            });
          }, 15 * 60 * 1000);
          
          return registration;
          
        } catch (error) {
          console.error('[Service Worker] Registration failed:', error);
          throw error;
        }
      };
      
      // Handle iOS-specific registration
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      
      // For iOS, wait for the page to be fully loaded before registering
      if (isIOS) {
        console.log('iOS device detected, waiting for page load...');
        window.addEventListener('load', () => {
          console.log('Page fully loaded, registering service worker...');
          registerServiceWorker().catch(console.error);
        }, { once: true });
      } else {
        // For other browsers, register immediately
        console.log('Registering service worker immediately...');
        registerServiceWorker().catch(console.error);
      }
    } else {
      console.warn('Service workers are not supported in this browser');
    }

    // Inicializa o aplicativo quando o DOM estiver pronto
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize other components
      atualizarDropdown();
      atualizarLista();
      exibirHistoricoSessoes();
      
      // Initialize the stopwatch
      document.getElementById('startStop').addEventListener('click', function() {
        if (isRunning) {
          clearInterval(stopwatchInterval);
          this.innerHTML = '<i class="fas fa-play"></i>';
        } else {
          stopwatchInterval = setInterval(updateStopwatch, 1000);
          this.innerHTML = '<i class="fas fa-pause"></i>';
        }
        isRunning = !isRunning;
      });

      document.getElementById('reset').addEventListener('click', function() {
        clearInterval(stopwatchInterval);
        seconds = 0;
        isRunning = false;
        document.getElementById('stopwatch').textContent = '00:00:00';
        document.getElementById('startStop').innerHTML = '<i class="fas fa-play"></i>';
        document.getElementById('laps').innerHTML = '';
      });
      
      document.getElementById('lap').addEventListener('click', function() {
        if (seconds > 0) {
          const lapTime = document.getElementById('stopwatch').textContent;
          const lapElement = document.createElement('div');
          lapElement.className = 'lap-time';
          lapElement.textContent = `Volta ${document.getElementById('laps').children.length + 1}: ${lapTime}`;
          document.getElementById('laps').prepend(lapElement);
        }
      });
      
      // Stopwatch will now only start when the start button is pressed
    });
  </script>
  </div>
</body>
</html>
