<!DOCTYPE html>
<html lang="pt-br" dir="ltr">
<head>
  <meta charset="UTF-8">
  <title>Gerenciador de Treino</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#007bff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="Gerenciador de Treino">
  <meta name="apple-mobile-web-app-title" content="Workout App">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' cdnjs.cloudflare.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' cdnjs.cloudflare.com; img-src 'self' data:;">
  
  <!-- Preload critical resources -->
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"></noscript>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
      background: #f4f4f4;
      color: #333;
    }
    h1, h2 {
      text-align: center;
    }
    input, select, button {
      width: 100%;
      padding: 0.8em;
      margin: 0.5em 0;
      font-size: 1em;
      box-sizing: border-box;
    }
    /* Stopwatch Styles */
    .stopwatch-container {
      text-align: center;
      margin: 20px 0;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #stopwatch {
      font-size: 2em;
      font-family: monospace;
      font-weight: bold;
      margin: 10px 0;
      color: #007BFF;
    }
    
    .stopwatch-controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 10px 0;
    }
    
    .stopwatch-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      background: #007BFF;
      color: white;
      font-size: 1.2em;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .stopwatch-btn:active {
      transform: scale(0.95);
    }
    
    #startStop {
      background: #28a745;
    }
    
    #reset {
      background: #dc3545;
    }
    
    #lap {
      background: #ffc107;
      color: #212529;
    }
    
    .laps-container {
      margin-top: 15px;
      max-height: 150px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .lap-time {
      padding: 8px;
      margin: 5px 0;
      background: #f8f9fa;
      border-radius: 4px;
      font-family: monospace;
    }
    
    button {
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .salvar-btn {
      background-color: #28a745;
      margin-top: 10px;
    }
    .salvar-btn:hover {
      background-color: #218838;
    }
    .contadores {
      display: none;
      text-align: center;
      margin-top: 1em;
    }
    .contador-btn {
      width: 48%;
      margin: 0.5em 1%;
    }
    .contador-input {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 10px 0;
    }
    .contador-input label {
      margin-right: 10px;
      min-width: 100px;
      text-align: right;
    }
    .contador-input input {
      width: 80px;
      text-align: center;
      margin: 0 5px;
    }
    #lista-exercicios {
      list-style: none;
      padding: 0;
    }
    #lista-exercicios li {
      padding: 0.4em;
      background: #ddd;
      margin: 0.3em 0;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
    }
    .remover {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
      padding: 0;
      flex-shrink: 0;
    }
    .remover:hover {
      background: #c82333;
    }
    
    .export-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .export-btn:first-child {
      background-color: #28a745;
    }
    
    .export-btn:first-child:hover {
      background-color: #218838;
    }
  </style>
</head>
<body>

  <h1>üèãÔ∏è Gerenciador de Treino</h1>
  <div class="stopwatch-container">
    <div id="stopwatch">00:00:00</div>
    <div class="stopwatch-controls">
      <button id="startStop" class="stopwatch-btn"><i class="fas fa-play"></i></button>
      <button id="reset" class="stopwatch-btn"><i class="fas fa-redo"></i></button>
      <button id="lap" class="stopwatch-btn"><i class="fas fa-flag"></i></button>
    </div>
    <div id="laps" class="laps-container"></div>
  </div>

  <!-- Sele√ß√£o -->
  <form onsubmit="event.preventDefault(); iniciarTreino();">
    <label for="exercicio-select">Selecionar exerc√≠cio:</label>
    <select id="exercicio-select" required>
      <option value="">-- Selecione --</option>
    </select>
    <button type="submit">Iniciar Execu√ß√£o</button>
  </form>

  <!-- Contadores -->
  <div id="contadores" class="contadores">
    <h2 id="exercicio-nome"></h2>
    
    <button class="contador-btn" onclick="incrementar('exec')">+ Execu√ß√£o</button>
    <span>Execu√ß√µes: <strong id="exec-count">0</strong></span><br>
    
    <div class="contador-input">
      <label for="rep-count">Repeti√ß√µes:</label>
      <input type="number" id="rep-count" value="0" min="0" onchange="atualizarContador('rep', this.value)">
    </div>
    
    <div class="contador-input">
      <label for="carga1">Carga 1 (kg):</label>
      <input type="number" id="carga1" value="0" min="0" step="0.5" onchange="atualizarCarga('carga1', this.value)">
    </div>
    
    <div class="contador-input">
      <label for="carga2">Carga 2 (kg):</label>
      <input type="number" id="carga2" min="0" step="0.5" onchange="atualizarCarga('carga2', this.value)">
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 15px;">
      <button type="button" onclick="salvarSessao()" class="salvar-btn">üíæ Salvar Exerc√≠cio</button>
    </div>
    <div id="sessao-salva" style="display: none; margin: 10px 0; padding: 10px; background: #e8f5e9; color: #2e7d32; border-radius: 4px;">
      Exerc√≠cio salvo com sucesso!
    </div>
  </div>
  
  <!-- Hist√≥rico de Sess√µes -->
  <div id="historico-container" style="margin-top: 30px;">
    <h2>Hist√≥rico de Sess√µes</h2>
    <div id="historico-sessoes" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px; background: white; min-height: 60px; margin-bottom: 15px;">
      <p style="margin: 0; color: #666; font-style: italic;">Nenhuma sess√£o salva ainda.</p>
    </div>
    
    <div style="margin: 15px 0; display: flex; justify-content: center;">
      <button type="button" onclick="finalizarSessao()" class="finalizar-btn" style="
        background-color: #007BFF;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background-color 0.2s;
      ">
        <i class="fas fa-flag-checkered"></i> Finalizar Sess√£o
      </button>
    </div>
    <style>
      .finalizar-btn:hover {
        background-color: #0056b3 !important;
      }
    </style>
    
    <div style="margin-top: 10px; display: flex; gap: 10px; justify-content: flex-end;">
      <button onclick="exportarCSV()" class="export-btn">
        <i class="fas fa-file-csv"></i> Exportar CSV
      </button>
      <button onclick="exportarHTML()" class="export-btn">
        <i class="fas fa-file-export"></i> Exportar HTML
      </button>
    </div>
  </div>

  <!-- Cadastro -->
  <h2>Cadastrar Novo Exerc√≠cio</h2>
  <input type="text" id="novo-exercicio" placeholder="Nome do exerc√≠cio">
  <button onclick="adicionarExercicio()">Adicionar</button>

  <!-- Lista -->
  <h2>Exerc√≠cios Cadastrados</h2>
  <ul id="lista-exercicios"></ul>

  <script>
    let execucoes = 0;
    let repeticoes = 0;
    let carga1 = 0;
    let carga2 = null;
    let exercicioAtual = "";
    let dataSessao = null;
    let historicoTreino = [];

    function salvarLista(lista) {
      localStorage.setItem("exercicios", JSON.stringify(lista));
    }

    function carregarLista() {
      return JSON.parse(localStorage.getItem("exercicios")) || [];
    }

    function atualizarDropdown() {
      const select = document.getElementById("exercicio-select");
      select.innerHTML = '<option value="">-- Selecione --</option>';
      const lista = carregarLista();
      lista.forEach(ex => {
        const opt = document.createElement("option");
        opt.value = ex;
        opt.textContent = ex;
        select.appendChild(opt);
      });
    }

    function atualizarLista() {
      const ul = document.getElementById("lista-exercicios");
      ul.innerHTML = "";
      const lista = carregarLista();
      lista.forEach((ex, i) => {
        const li = document.createElement("li");
        li.textContent = ex;
        const btn = document.createElement("button");
        btn.textContent = "x";
        btn.className = "remover";
        btn.onclick = () => {
          lista.splice(i, 1);
          salvarLista(lista);
          atualizarLista();
          atualizarDropdown();
        };
        li.appendChild(btn);
        ul.appendChild(li);
      });
    }

    function adicionarExercicio() {
      const nome = document.getElementById("novo-exercicio").value.trim();
      if (!nome) return;
      const lista = carregarLista();
      if (!lista.includes(nome)) {
        lista.push(nome);
        salvarLista(lista);
        atualizarLista();
        atualizarDropdown();
        document.getElementById("novo-exercicio").value = "";
      }
    }

    function iniciarTreino() {
      const select = document.getElementById("exercicio-select");
      const nome = select.value;
      if (!nome) return alert("Selecione um exerc√≠cio.");
      exercicioAtual = nome;
      execucoes = 0;
      repeticoes = 0;
      carga1 = 0;
      carga2 = null;
      // Clear form
      document.getElementById('exercicio-select').value = '';
      document.getElementById("exec-count").textContent = execucoes;
      document.getElementById("rep-count").value = repeticoes;
      document.getElementById("carga1").value = carga1;
      document.getElementById("carga2").value = '';
      document.getElementById("exercicio-nome").textContent = nome;
      document.getElementById("contadores").style.display = "block";
      
      // Set session date/time only if not already set
      if (!dataSessao) {
        dataSessao = new Date();
      }
    }

    function incrementar(tipo) {
      if (tipo === "exec") execucoes++;
      if (tipo === "rep") repeticoes++;
      document.getElementById("exec-count").textContent = execucoes;
      document.getElementById("rep-count").value = repeticoes;
    }

    function atualizarContador(tipo, valor) {
      valor = parseInt(valor) || 0;
      if (tipo === "rep") repeticoes = valor;
      document.getElementById("rep-count").value = repeticoes;
    }
    
    function atualizarCarga(tipo, valor) {
      if (tipo === 'carga1') {
        carga1 = parseFloat(valor) || 0;
        document.getElementById("carga1").value = carga1;
      } else if (tipo === 'carga2') {
        carga2 = valor === '' ? null : parseFloat(valor);
        document.getElementById("carga2").value = carga2 === null ? '' : carga2;
      }
    }

    function salvarSessao() {
      if (!exercicioAtual) return alert("Nenhum exerc√≠cio em andamento.");
      
      const dataAtual = new Date();
      const dataAtualFormatada = dataAtual.toLocaleDateString('pt-BR');
      const sessionEnded = localStorage.getItem(`sessionEnded_${dataAtualFormatada}`) === 'true';
      
      // If previous session was ended, start a new one
      if (sessionEnded) {
        // Clear the session ended flag for the current date
        localStorage.removeItem(`sessionEnded_${dataAtualFormatada}`);
        // Reset the end session button
        const endSessionBtn = document.querySelector('.finalizar-btn');
        if (endSessionBtn) {
          endSessionBtn.disabled = false;
          endSessionBtn.style.opacity = '1';
          endSessionBtn.style.cursor = 'pointer';
        }
        // Show new session started message
        const successMsg = document.getElementById('sessao-salva');
        successMsg.textContent = 'Nova sess√£o iniciada!';
        successMsg.style.display = 'block';
        successMsg.style.backgroundColor = '#e6f7ff';
        successMsg.style.color = '#1890ff';
        setTimeout(() => { successMsg.style.display = 'none'; }, 3000);
      }
      
      // Use the current time for the session
      const dataSessaoAtual = dataSessao || new Date();
      const dataFormatada = dataSessaoAtual.toLocaleString('pt-BR');
      
      // Generate a session ID if this is a new session
      const sessionId = sessionEnded ? Date.now().toString() : 
                        (localStorage.getItem('currentSessionId') || Date.now().toString());
      
      // Store the current session ID
      localStorage.setItem('currentSessionId', sessionId);
      
      const sessao = {
        data: dataSessaoAtual.toISOString(),
        exercicio: exercicioAtual,
        execucoes: execucoes,
        repeticoes: repeticoes,
        carga1: carga1,
        carga2: carga2,
        dataFormatada: dataFormatada,
        sessionId: sessionId  // Add session ID to track session boundaries
      };
      
      // Get existing sessions or initialize empty array
      const sessoes = JSON.parse(localStorage.getItem("sessoes")) || [];
      sessoes.unshift(sessao); // Add to beginning of array to show newest first
      
      // Save to localStorage
      localStorage.setItem("sessoes", JSON.stringify(sessoes));
      
      // Show success message
      const successMsg = document.getElementById('sessao-salva');
      successMsg.textContent = 'Exerc√≠cio salvo com sucesso!';
      successMsg.style.display = 'block';
      setTimeout(() => {
        successMsg.style.display = 'none';
      }, 3000);
      
      // Update the displayed history
      exibirHistoricoSessoes();
      
      // Reset for next exercise
      document.getElementById("exercicio-select").value = "";
      document.getElementById("contadores").style.display = "none";
      exercicioAtual = "";
      dataSessao = null; // Reset session date for next session
    }
    
    function finalizarSessao() {
      // Get current session ID
      const currentSessionId = localStorage.getItem('currentSessionId');
      if (!currentSessionId) {
        mostrarMensagem('Nenhuma sess√£o ativa para finalizar.', 'info');
        return;
      }
      
      // Get current sessions
      const sessoes = JSON.parse(localStorage.getItem("sessoes") || "[]");
      const currentSessionExercises = sessoes.filter(s => s.sessionId === currentSessionId && !s.isSessionEnd);
      
      if (currentSessionExercises.length === 0) {
        mostrarMensagem('Nenhum exerc√≠cio encontrado nesta sess√£o.', 'info');
        return;
      }
      
      // Add session end marker to the sessions array
      const now = new Date();
      const sessionEndMarker = {
        isSessionEnd: true,
        sessionId: currentSessionId,
        data: now.toISOString(),
        dataFormatada: now.toLocaleString('pt-BR')
      };
      
      // Remove any existing end marker for this session
      const updatedSessoes = sessoes.filter(s => !(s.sessionId === currentSessionId && s.isSessionEnd));
      updatedSessoes.push(sessionEndMarker);
      localStorage.setItem("sessoes", JSON.stringify(updatedSessoes));
      
      // Mark this session as ended
      const endedSessions = JSON.parse(localStorage.getItem('endedSessions') || '{}');
      endedSessions[currentSessionId] = true;
      localStorage.setItem('endedSessions', JSON.stringify(endedSessions));
      
      // Clear current session ID to force new session on next save
      localStorage.removeItem('currentSessionId');
      
      // Update the UI immediately
      mostrarMensagem('Sess√£o finalizada com sucesso!', 'success');
      exibirHistoricoSessoes();
      
      // Scroll to show the session end message
      setTimeout(() => {
        const historicoDiv = document.getElementById('historico-sessoes');
        if (historicoDiv) {
          historicoDiv.scrollTop = historicoDiv.scrollHeight;
        }
      }, 50);
    }
    
    function exibirHistoricoSessoes() {
      const historicoDiv = document.getElementById("historico-sessoes");
      const sessoes = JSON.parse(localStorage.getItem("sessoes")) || [];
      
      if (sessoes.length === 0) {
        historicoDiv.innerHTML = "<p style=\"margin: 0; color: #666; font-style: italic;\">Nenhuma sess√£o salva ainda.</p>";
        return;
      }
      
      // Group sessions by date and session ID
      const sessoesPorData = {};
      const endedSessions = JSON.parse(localStorage.getItem('endedSessions') || '{}');
      
      // First, group by date and session ID
      sessoes.forEach((sessao, index) => {
        const dataKey = new Date(sessao.data).toLocaleDateString('pt-BR');
        const sessionId = sessao.sessionId || 'default';
        
        if (!sessoesPorData[dataKey]) {
          sessoesPorData[dataKey] = {};
        }
        if (!sessoesPorData[dataKey][sessionId]) {
          sessoesPorData[dataKey][sessionId] = [];
        }
        
        // Add index to the session for deletion
        sessao.originalIndex = index;
        sessoesPorData[dataKey][sessionId].push(sessao);
      });
      
      let html = '';
      
      // Process each date
      for (const [data, sessionsByDate] of Object.entries(sessoesPorData)) {
        html += `
          <div style="margin-bottom: 25px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <div style="font-weight: bold; color: #333; margin-bottom: 8px; font-size: 1.1em;">${data}</div>
            <div style="border-top: 1px solid #eee; margin: 8px 0 12px 0;"></div>
        `;
        
        // Process each session within the date
        for (const [sessionId, sessoesDoDia] of Object.entries(sessionsByDate)) {
          // Separate exercises from session end markers
          const exercises = sessoesDoDia.filter(s => !s.isSessionEnd);
          const endMarkers = sessoesDoDia.filter(s => s.isSessionEnd);
          
          if (exercises.length === 0) continue; // Skip if no exercises in this session
          
          // Sort exercises by time (oldest first)
          exercises.sort((a, b) => new Date(a.data) - new Date(b.data));
          
          // Add session start message
          const primeiraSessao = exercises[0];
          const horaInicio = new Date(primeiraSessao.data).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
          
          html += `
            <div style="margin-bottom: 15px;">
              <div style="color: #1890ff; margin-bottom: 12px; padding: 8px 12px; background-color: #e6f7ff; border-left: 3px solid #1890ff; border-radius: 2px;">
                üïí ${horaInicio} - Sess√£o Iniciada
              </div>
          `;
          
          // Add exercises
          exercises.forEach((sessao) => {
            const hora = new Date(sessao.data).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            const stats = [
              `Execu√ß√µes: ${sessao.execucoes}`,
              `Repeti√ß√µes: ${sessao.repeticoes}`
            ];
            
            if (sessao.carga1 !== null && sessao.carga1 !== undefined) {
              stats.push(`Carga 1: ${sessao.carga1} kg`);
            }
            if (sessao.carga2 !== null && sessao.carga2 !== undefined) {
              stats.push(`Carga 2: ${sessao.carga2} kg`);
            }
            
            html += `
              <div style="margin: 8px 0; padding: 8px; background: white; border-radius: 4px; border: 1px solid #eee;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-weight: 500;">${hora} - ${sessao.exercicio}</span>
                  <button 
                    onclick="removerSessao(${sessao.originalIndex})" 
                    style="
                      background: #ff4d4f; 
                      color: white; 
                      border: none; 
                      border-radius: 4px; 
                      width: 24px;
                      height: 24px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      cursor: pointer;
                      font-size: 16px;
                      line-height: 1;
                      padding: 0;
                      margin-left: 10px;
                      transition: background-color 0.2s;
                    "
                    onmouseover="this.style.backgroundColor='#ff7875'"
                    onmouseout="this.style.backgroundColor='#ff4d4f'"
                    title="Excluir"
                  >
                    √ó
                  </button>
                </div>
                <div style="margin-top: 6px; padding-left: 4px;">
                  ${stats.map((stat, i) => {
                    const isLast = i === stats.length - 1;
                    const prefix = isLast ? '‚îî‚îÄ ' : '‚îú‚îÄ ';
                    return `<div style="color: #666; font-size: 0.9em; margin: 2px 0;">${prefix}${stat}</div>`;
                  }).join('')}
                </div>
              </div>
            `;
          });
          
          // Add session end message if exists
          if (endMarkers.length > 0) {
            const endMarker = endMarkers[0]; // Only use the first end marker if multiple exist
            const horaFim = new Date(endMarker.data).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            
            const startTime = new Date(primeiraSessao.data);
            const endTime = new Date(endMarker.data);
            const duracaoSegundos = Math.max(1, Math.ceil((endTime - startTime) / 1000));
            const duracaoMinutos = Math.floor(duracaoSegundos / 60);
            const segundosRestantes = duracaoSegundos % 60;
            const exerciciosCount = exercises.length;
            
            html += `
              <div style="margin-top: 16px; padding: 8px 12px; background-color: #f6ffed; border-left: 3px solid #52c41a; border-radius: 2px;">
                <div style="color: #52c41a; font-weight: 500;">
                  üïí ${horaFim} - Sess√£o Finalizada
                </div>
                <div style="color: #8c8c8c; margin-left: 20px; font-size: 0.9em; margin-top: 4px;">
                  <div>‚îî‚îÄ Dura√ß√£o: ${duracaoMinutos} minuto${duracaoMinutos !== 1 ? 's' : ''} e ${segundosRestantes} segundo${segundosRestantes !== 1 ? 's' : ''}</div>
                  <div>‚îî‚îÄ Exerc√≠cios realizados: ${exerciciosCount}</div>
                </div>
              </div>
            `;
          }
          
          // Close the session div
          html += `
            </div> <!-- End of session div -->
          `;
          
          html += `</div>`; // Close session container
        }
        
        html += `</div>`; // Close date container
      }
      
      historicoDiv.innerHTML = html;
    }
    
    function exportarCSV() {
      const sessoes = JSON.parse(localStorage.getItem("sessoes") || "[]");
      const sessoesPorData = {};
      
      // Group sessions by date and session ID
      sessoes.forEach((sessao, index) => {
        const dataKey = new Date(sessao.data).toLocaleDateString('pt-BR');
        const sessionId = sessao.sessionId || 'default';
        
        if (!sessoesPorData[dataKey]) {
          sessoesPorData[dataKey] = {};
        }
        if (!sessoesPorData[dataKey][sessionId]) {
          sessoesPorData[dataKey][sessionId] = [];
        }
        
        // Add index to the session for reference
        sessao.originalIndex = index;
        sessoesPorData[dataKey][sessionId].push(sessao);
      });
      
      if (Object.keys(sessoesPorData).length === 0) {
        return alert("Nenhuma sess√£o salva para exportar.");
      }
      
      // Create CSV header
      let csv = "Tipo;Data/Hora;Detalhe;Dura√ß√£o;Exerc√≠cio;Execu√ß√µes;Repeti√ß√µes;Carga 1 (kg);Carga 2 (kg)\n";
      
      // Process each date and session
      for (const [data, sessionsByDate] of Object.entries(sessoesPorData)) {
        for (const [sessionId, sessoesDoDia] of Object.entries(sessionsByDate)) {
          // Separate exercises from session end markers
          const exercises = sessoesDoDia.filter(s => !s.isSessionEnd);
          const endMarkers = sessoesDoDia.filter(s => s.isSessionEnd);
          
          if (exercises.length === 0) continue;
          
          // Sort by time
          exercises.sort((a, b) => new Date(a.data) - new Date(b.data));
          
          // Add session start
          const startTime = new Date(exercises[0].data);
          csv += `"Sess√£o Iniciada";"${startTime.toLocaleString('pt-BR')}";"In√≠cio da sess√£o de treino";"";"";"";"";"";""\n`;
          
          // Add exercises
          exercises.forEach(sessao => {
            const dataHora = new Date(sessao.data).toLocaleString('pt-BR');
            const carga1 = sessao.carga1 || 0;
            const carga2 = sessao.carga2 !== null && sessao.carga2 !== undefined ? sessao.carga2 : '';
            csv += `"Exerc√≠cio";"${dataHora}";"${sessao.exercicio}";"";"${sessao.exercicio}";${sessao.execucoes};${sessao.repeticoes};${carga1};${carga2}\n`;
          });
          
          // Add session end if exists
          if (endMarkers.length > 0) {
            const endMarker = endMarkers[0];
            const endTime = new Date(endMarker.data);
            const duracaoSegundos = Math.max(1, Math.ceil((endTime - startTime) / 1000));
            const duracaoMinutos = Math.floor(duracaoSegundos / 60);
            const segundosRestantes = duracaoSegundos % 60;
            const duracaoFormatada = `${duracaoMinutos}:${segundosRestantes.toString().padStart(2, '0')}`;
            
            csv += `"Sess√£o Finalizada";"${endTime.toLocaleString('pt-BR')}";"Fim da sess√£o de treino";"${duracaoFormatada}";"";"${exercises.length}";"";"";""\n`;
          }
          
          // Add empty line between sessions
          csv += "\n";
        }
      }
      
      // Create and trigger download
      const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `historico_treino_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
    }
    
    function exportarHTML() {
      const sessoes = JSON.parse(localStorage.getItem('sessoes') || '[]');
      const sessoesAgrupadas = {};
      
      // Group sessions by date and session ID
      sessoes.forEach((sessao, index) => {
        const dataKey = new Date(sessao.data).toLocaleDateString('pt-BR');
        const sessionId = sessao.sessionId || 'default';
        
        if (!sessoesAgrupadas[dataKey]) {
          sessoesAgrupadas[dataKey] = {};
        }
        if (!sessoesAgrupadas[dataKey][sessionId]) {
          sessoesAgrupadas[dataKey][sessionId] = [];
        }
        
        sessao.originalIndex = index;
        sessoesAgrupadas[dataKey][sessionId].push(sessao);
      });
      
      if (Object.keys(sessoesAgrupadas).length === 0) {
        alert('Nenhum dado para exportar.');
        return;
      }
      
      // Create HTML document
      let html = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <title>Hist√≥rico de Treinos</title>
        <style>
          body { 
            font-family: Arial, sans-serif; 
            line-height: 1.6; 
            color: #333; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f5f5f5;
          }
          h1 { 
            color: #1890ff; 
            text-align: center; 
            margin-bottom: 30px;
          }
          .export-date {
            text-align: right;
            color: #666;
            margin-bottom: 20px;
            font-size: 0.9em;
          }
          .session-date { 
            font-size: 1.3em; 
            font-weight: bold; 
            margin: 30px 0 15px; 
            padding-bottom: 8px; 
            border-bottom: 2px solid #1890ff;
            color: #333;
          }
          .session { 
            margin-bottom: 30px; 
            background: white; 
            padding: 20px; 
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
          }
          .session-start { 
            color: #1890ff; 
            background-color: #e6f7ff; 
            padding: 10px 15px; 
            border-left: 4px solid #1890ff; 
            margin: 0 0 15px 0;
            border-radius: 4px;
            font-weight: 500;
          }
          .exercise { 
            margin: 15px 0; 
            padding: 12px; 
            background: white; 
            border-radius: 6px; 
            border: 1px solid #eee;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
          }
          .exercise-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 8px;
          }
          .exercise-time { 
            font-weight: bold;
            color: #333;
          }
          .exercise-name { 
            font-weight: 500;
            color: #1890ff;
          }
          .exercise-stats { 
            margin-left: 15px; 
            color: #555; 
            font-size: 0.95em;
            line-height: 1.5;
          }
          .session-end { 
            color: #52c41a; 
            background-color: #f6ffed; 
            padding: 10px 15px; 
            border-left: 4px solid #52c41a; 
            margin: 15px 0 0 0;
            border-radius: 4px;
            font-weight: 500;
          }
          .stat-line {
            margin: 4px 0;
            padding-left: 10px;
            position: relative;
          }
          .stat-line:before {
            content: "‚Ä¢";
            position: absolute;
            left: 0;
            color: #999;
          }
          .session-duration {
            font-weight: 500;
            color: #333;
          }
        </style>
      </head>
      <body>
        <h1>Hist√≥rico de Treinos</h1>
        <div class="export-date">Exportado em: ${new Date().toLocaleString('pt-BR')}</div>
      `;
      
      // Sort dates in descending order (newest first)
      const datasOrdenadas = Object.keys(sessoesAgrupadas).sort((a, b) => 
        new Date(b.split('/').reverse().join('-')) - new Date(a.split('/').reverse().join('-'))
      );
      
      // Process each date
      datasOrdenadas.forEach(data => {
        html += `<div class="session-date">${data}</div>`;
        const sessoesDoDia = sessoesAgrupadas[data];
        
        // Process each session for this date
        Object.values(sessoesDoDia).forEach(sessoes => {
          if (sessoes.length === 0) return;
          
          // Separate exercises from session end markers
          const exercises = sessoes.filter(s => !s.isSessionEnd);
          const endMarkers = sessoes.filter(s => s.isSessionEnd);
          
          if (exercises.length === 0) return;
          
          // Sort by time
          exercises.sort((a, b) => new Date(a.data) - new Date(b.data));
          
          // Add session start
          const startTime = new Date(exercises[0].data);
          const formattedStartTime = startTime.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
          
          html += `
            <div class="session">
              <div class="session-start">
                üïí ${formattedStartTime} - Sess√£o Iniciada
              </div>
          `;
          
          // Add exercises
          exercises.forEach(sessao => {
            const hora = new Date(sessao.data).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            const stats = [
              sessao.execucoes ? `Execu√ß√µes: ${sessao.execucoes}` : null,
              sessao.repeticoes ? `Repeti√ß√µes: ${sessao.repeticoes}` : null,
              sessao.carga1 !== undefined ? `Carga 1: ${sessao.carga1} kg` : null,
              sessao.carga2 !== undefined && sessao.carga2 !== '' ? `Carga 2: ${sessao.carga2} kg` : null
            ].filter(Boolean);
            
            html += `
              <div class="exercise">
                <div class="exercise-header">
                  <span class="exercise-time">${hora}</span>
                  <span class="exercise-name">${sessao.exercicio}</span>
                </div>
                <div class="exercise-stats">
                  ${stats.map(stat => `<div class="stat-line">${stat}</div>`).join('')}
                </div>
              </div>
            `;
          });
          
          // Add session end if exists
          if (endMarkers.length > 0) {
            const endMarker = endMarkers[0];
            const endTime = new Date(endMarker.data);
            const formattedEndTime = endTime.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            
            // Calculate duration
            const duracaoSegundos = Math.max(1, Math.ceil((endTime - startTime) / 1000));
            const duracaoMinutos = Math.floor(duracaoSegundos / 60);
            const segundosRestantes = duracaoSegundos % 60;
            
            html += `
              <div class="session-end">
                <div>üïí ${formattedEndTime} - Sess√£o Finalizada</div>
                <div class="exercise-stats">
                  <div class="stat-line">Dura√ß√£o: <span class="session-duration">${duracaoMinutos} minuto${duracaoMinutos !== 1 ? 's' : ''} e ${segundosRestantes} segundo${segundosRestantes !== 1 ? 's' : ''}</span></div>
                  <div class="stat-line">Exerc√≠cios realizados: <span class="session-duration">${exercises.length}</span></div>
                </div>
              </div>
            `;
          }
          
          html += `</div>`; // Close session div
        });
      });
      
      // Close HTML document
      html += `
        </body>
        </html>
      `;
      
      // Create and trigger download
      const blob = new Blob([html], { type: 'text/html;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `historico_treino_${new Date().toISOString().slice(0,10)}.html`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      // Stopwatch functionality
      let stopwatchInterval;
      let seconds = 0;
      let isRunning = false;
      
      function updateStopwatch() {
        seconds++;
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        document.getElementById('stopwatch').textContent = 
          `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      }
      
      document.getElementById('startStop').addEventListener('click', function() {
        if (isRunning) {
          clearInterval(stopwatchInterval);
          this.innerHTML = '<i class="fas fa-play"></i>';
        } else {
          stopwatchInterval = setInterval(updateStopwatch, 1000);
          this.innerHTML = '<i class="fas fa-pause"></i>';
        }
        isRunning = !isRunning;
      });
      
      document.getElementById('reset').addEventListener('click', function() {
        clearInterval(stopwatchInterval);
        seconds = 0;
        document.getElementById('stopwatch').textContent = '00:00:00';
        document.getElementById('startStop').innerHTML = '<i class="fas fa-play"></i>';
        document.getElementById('laps').innerHTML = '';
        isRunning = false;
      });
      
      document.getElementById('lap').addEventListener('click', function() {
        if (seconds > 0) {
          const lapTime = document.getElementById('stopwatch').textContent;
          const lapElement = document.createElement('div');
          lapElement.className = 'lap-time';
          lapElement.textContent = `Volta ${document.getElementById('laps').children.length + 1}: ${lapTime}`;
          document.getElementById('laps').prepend(lapElement);
        }
      });
      
      // Inicializa√ß√£o
      atualizarDropdown();
      atualizarLista();
      exibirHistoricoSessoes();
    }

    function removerSessao(index) {
      if (!confirm('Tem certeza que deseja excluir esta sess√£o?')) return;
      
      const sessoes = JSON.parse(localStorage.getItem("sessoes")) || [];
      if (index >= 0 && index < sessoes.length) {
        sessoes.splice(index, 1);
        localStorage.setItem("sessoes", JSON.stringify(sessoes));
        exibirHistoricoSessoes();
      }
    }
    
    // Stopwatch functionality
    let stopwatchInterval;
    let seconds = 0;
    let isRunning = false;
    
    function updateStopwatch() {
      seconds++;
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      
      document.getElementById('stopwatch').textContent = 
        `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }
    
    document.getElementById('startStop').addEventListener('click', function() {
      if (isRunning) {
        clearInterval(stopwatchInterval);
        this.innerHTML = '<i class="fas fa-play"></i>';
      } else {
        stopwatchInterval = setInterval(updateStopwatch, 1000);
        this.innerHTML = '<i class="fas fa-pause"></i>';
      }
      isRunning = !isRunning;
    });
    
    document.getElementById('reset').addEventListener('click', function() {
      clearInterval(stopwatchInterval);
      seconds = 0;
      document.getElementById('stopwatch').textContent = '00:00:00';
      document.getElementById('startStop').innerHTML = '<i class="fas fa-play"></i>';
      document.getElementById('laps').innerHTML = '';
      isRunning = false;
    });
    
    document.getElementById('lap').addEventListener('click', function() {
      if (seconds > 0) {
        const lapTime = document.getElementById('stopwatch').textContent;
        const lapElement = document.createElement('div');
        lapElement.className = 'lap-time';
        lapElement.textContent = `Volta ${document.getElementById('laps').children.length + 1}: ${lapTime}`;
        document.getElementById('laps').prepend(lapElement);
      }
    });
    
    // Inicializa√ß√£o
    atualizarDropdown();
    atualizarLista();
    exibirHistoricoSessoes();
  </script>

</body>
</html>
