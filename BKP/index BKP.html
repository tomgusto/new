<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Gerenciador de Treino</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
      background: #f4f4f4;
      color: #333;
    }
    h1, h2 {
      text-align: center;
    }
    input, select, button {
      width: 100%;
      padding: 0.8em;
      margin: 0.5em 0;
      font-size: 1em;
      box-sizing: border-box;
    }
    button {
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .salvar-btn {
      background-color: #28a745;
      margin-top: 10px;
    }
    .salvar-btn:hover {
      background-color: #218838;
    }
    .contadores {
      display: none;
      text-align: center;
      margin-top: 1em;
    }
    .contador-btn {
      width: 48%;
      margin: 0.5em 1%;
    }
    .contador-input {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 10px 0;
    }
    .contador-input label {
      margin-right: 10px;
      min-width: 100px;
      text-align: right;
    }
    .contador-input input {
      width: 80px;
      text-align: center;
      margin: 0 5px;
    }
    #lista-exercicios {
      list-style: none;
      padding: 0;
    }
    #lista-exercicios li {
      padding: 0.4em;
      background: #ddd;
      margin: 0.3em 0;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
    }
    .remover {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
      padding: 0;
      flex-shrink: 0;
    }
    .remover:hover {
      background: #c82333;
    }
    
    .export-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .export-btn:first-child {
      background-color: #28a745;
    }
    
    .export-btn:first-child:hover {
      background-color: #218838;
    }
  </style>
</head>
<body>

  <h1>üèãÔ∏è Gerenciador de Treino</h1>

  <!-- Sele√ß√£o -->
  <form onsubmit="event.preventDefault(); iniciarTreino();">
    <label for="exercicio-select">Selecionar exerc√≠cio:</label>
    <select id="exercicio-select" required>
      <option value="">-- Selecione --</option>
    </select>
    <button type="submit">Iniciar Execu√ß√£o</button>
  </form>

  <!-- Contadores -->
  <div id="contadores" class="contadores">
    <h2 id="exercicio-nome"></h2>
    
    <button class="contador-btn" onclick="incrementar('exec')">+ Execu√ß√£o</button>
    <span>Execu√ß√µes: <strong id="exec-count">0</strong></span><br>
    
    <div class="contador-input">
      <label for="rep-count">Repeti√ß√µes:</label>
      <input type="number" id="rep-count" value="0" min="0" onchange="atualizarContador('rep', this.value)">
    </div>
    
    <div class="contador-input">
      <label for="carga1">Carga 1 (kg):</label>
      <input type="number" id="carga1" value="0" min="0" step="0.5" onchange="atualizarCarga('carga1', this.value)">
    </div>
    
    <div class="contador-input">
      <label for="carga2">Carga 2 (kg):</label>
      <input type="number" id="carga2" min="0" step="0.5" onchange="atualizarCarga('carga2', this.value)">
    </div>
    
    <button type="button" onclick="salvarSessao()" class="salvar-btn">üíæ Salvar</button>
    <div id="sessao-salva" style="display: none; margin: 10px 0; padding: 10px; background: #e8f5e9; color: #2e7d32; border-radius: 4px;">
      Sess√£o salva com sucesso!
    </div>
  </div>
  
  <!-- Hist√≥rico de Sess√µes -->
  <div id="historico-container" style="margin-top: 30px;">
    <h2>Hist√≥rico de Sess√µes</h2>
    <div id="historico-sessoes" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px; background: white; min-height: 60px;">
      <p style="margin: 0; color: #666; font-style: italic;">Nenhuma sess√£o salva ainda.</p>
    </div>
    
    <!-- Bot√µes de Exporta√ß√£o -->
    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button type="button" onclick="exportarCSV()" class="export-btn">üì§ Exportar CSV</button>
      <button type="button" onclick="exportarPDF()" class="export-btn" style="background-color: #dc3545;">üìÑ Exportar PDF</button>
    </div>
  </div>

  <!-- Cadastro -->
  <h2>Cadastrar Novo Exerc√≠cio</h2>
  <input type="text" id="novo-exercicio" placeholder="Nome do exerc√≠cio">
  <button onclick="adicionarExercicio()">Adicionar</button>

  <!-- Lista -->
  <h2>Exerc√≠cios Cadastrados</h2>
  <ul id="lista-exercicios"></ul>

  <script>
    let execucoes = 0;
    let repeticoes = 0;
    let carga1 = 0;
    let carga2 = null;
    let exercicioAtual = "";
    let dataSessao = null;

    function salvarLista(lista) {
      localStorage.setItem("exercicios", JSON.stringify(lista));
    }

    function carregarLista() {
      return JSON.parse(localStorage.getItem("exercicios")) || [];
    }

    function atualizarDropdown() {
      const select = document.getElementById("exercicio-select");
      select.innerHTML = '<option value="">-- Selecione --</option>';
      const lista = carregarLista();
      lista.forEach(ex => {
        const opt = document.createElement("option");
        opt.value = ex;
        opt.textContent = ex;
        select.appendChild(opt);
      });
    }

    function atualizarLista() {
      const ul = document.getElementById("lista-exercicios");
      ul.innerHTML = "";
      const lista = carregarLista();
      lista.forEach((ex, i) => {
        const li = document.createElement("li");
        li.textContent = ex;
        const btn = document.createElement("button");
        btn.textContent = "x";
        btn.className = "remover";
        btn.onclick = () => {
          lista.splice(i, 1);
          salvarLista(lista);
          atualizarLista();
          atualizarDropdown();
        };
        li.appendChild(btn);
        ul.appendChild(li);
      });
    }

    function adicionarExercicio() {
      const nome = document.getElementById("novo-exercicio").value.trim();
      if (!nome) return;
      const lista = carregarLista();
      if (!lista.includes(nome)) {
        lista.push(nome);
        salvarLista(lista);
        atualizarLista();
        atualizarDropdown();
        document.getElementById("novo-exercicio").value = "";
      }
    }

    function iniciarTreino() {
      const select = document.getElementById("exercicio-select");
      const nome = select.value;
      if (!nome) return alert("Selecione um exerc√≠cio.");
      exercicioAtual = nome;
      execucoes = 0;
      repeticoes = 0;
      carga1 = 0;
      carga2 = null;
      document.getElementById("exec-count").textContent = execucoes;
      document.getElementById("rep-count").value = repeticoes;
      document.getElementById("carga1").value = carga1;
      document.getElementById("carga2").value = '';
      document.getElementById("exercicio-nome").textContent = nome;
      document.getElementById("contadores").style.display = "block";
      
      // Set session date/time only if not already set
      if (!dataSessao) {
        dataSessao = new Date();
      }
    }

    function incrementar(tipo) {
      if (tipo === "exec") execucoes++;
      if (tipo === "rep") repeticoes++;
      document.getElementById("exec-count").textContent = execucoes;
      document.getElementById("rep-count").value = repeticoes;
    }

    function atualizarContador(tipo, valor) {
      valor = parseInt(valor) || 0;
      if (tipo === "rep") repeticoes = valor;
      document.getElementById("rep-count").value = repeticoes;
    }
    
    function atualizarCarga(tipo, valor) {
      if (tipo === 'carga1') {
        carga1 = parseFloat(valor) || 0;
        document.getElementById("carga1").value = carga1;
      } else if (tipo === 'carga2') {
        carga2 = valor === '' ? null : parseFloat(valor);
        document.getElementById("carga2").value = carga2 === null ? '' : carga2;
      }
    }

    function salvarSessao() {
      if (!exercicioAtual) return alert("Nenhum exerc√≠cio em andamento.");
      
      const dataAtual = dataSessao || new Date();
      const dataFormatada = dataAtual.toLocaleString('pt-BR');
      
      const sessao = {
        data: dataAtual.toISOString(),
        exercicio: exercicioAtual,
        execucoes: execucoes,
        repeticoes: repeticoes,
        carga1: carga1,
        carga2: carga2,
        dataFormatada: dataFormatada
      };
      
      // Get existing sessions or initialize empty array
      const sessoes = JSON.parse(localStorage.getItem("sessoes")) || [];
      sessoes.unshift(sessao); // Add to beginning of array to show newest first
      
      // Save to localStorage
      localStorage.setItem("sessoes", JSON.stringify(sessoes));
      
      // Show success message
      const mensagem = document.getElementById("sessao-salva");
      mensagem.style.display = "block";
      setTimeout(() => {
        mensagem.style.display = "none";
      }, 3000);
      
      // Update the displayed history
      exibirHistoricoSessoes();
      
      // Reset for next exercise
      document.getElementById("exercicio-select").value = "";
      document.getElementById("contadores").style.display = "none";
      exercicioAtual = "";
      dataSessao = null; // Reset session date for next session
    }
    
    function exibirHistoricoSessoes() {
      const historicoDiv = document.getElementById("historico-sessoes");
      const sessoes = JSON.parse(localStorage.getItem("sessoes")) || [];
      
      if (sessoes.length === 0) {
        historicoDiv.innerHTML = "<p style=\"margin: 0; color: #666; font-style: italic;\">Nenhuma sess√£o salva ainda.</p>";
        return;
      }
      
      // Group sessions by date
      const sessoesPorData = {};
      sessoes.forEach((sessao, index) => {
        const dataKey = new Date(sessao.data).toLocaleDateString('pt-BR');
        if (!sessoesPorData[dataKey]) {
          sessoesPorData[dataKey] = [];
        }
        // Add index to the session for deletion
        sessao.originalIndex = index;
        sessoesPorData[dataKey].push(sessao);
      });
      
      let html = '';
      for (const [data, sessoesDoDia] of Object.entries(sessoesPorData)) {
        html += `<div style="margin-bottom: 15px;">`;
        html += `<h3 style="margin: 10px 0 5px 0; color: #007BFF;">${data}</h3>`;
        
        sessoesDoDia.forEach(sessao => {
          const hora = new Date(sessao.data).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
          html += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee;" class="sessao-item">
              <div>
                <span>${hora} - ${sessao.exercicio}</span>
                <span style="margin-left: 10px; color: #666; font-size: 0.9em;">
                  (Execu√ß√µes: ${sessao.execucoes} | Repeti√ß√µes: ${sessao.repeticoes}${sessao.carga1 ? ' | Carga 1: ' + sessao.carga1 + ' kg' : ''}${sessao.carga2 !== null && sessao.carga2 !== undefined ? ' | Carga 2: ' + sessao.carga2 + ' kg' : ''})
                </span>
              </div>
              <button onclick="removerSessao(${sessao.originalIndex})" class="remover" title="Excluir">
                √ó
              </button>
            </div>
          `;
        });
        
        html += `</div>`;
      }
      
      historicoDiv.innerHTML = html;
    }
    
    function exportarCSV() {
      const sessoes = JSON.parse(localStorage.getItem("sessoes")) || [];
      
      if (sessoes.length === 0) {
        return alert("Nenhuma sess√£o salva para exportar.");
      }
      
      // Create CSV header
      let csv = "Data;Exerc√≠cio;Execu√ß√µes;Repeti√ß√µes;Carga 1 (kg);Carga 2 (kg)\n";
      
      // Add each session to CSV
      sessoes.forEach(sessao => {
        const data = new Date(sessao.data).toLocaleString('pt-BR');
        const carga1 = sessao.carga1 || 0;
        const carga2 = sessao.carga2 !== null && sessao.carga2 !== undefined ? sessao.carga2 : '';
        csv += `"${data}";"${sessao.exercicio}";${sessao.execucoes};${sessao.repeticoes};${carga1};${carga2}\n`;
      });
      
      // Create and trigger download
      const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `historico_treino_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
    }
    
    function exportarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Title
      doc.setFontSize(20);
      doc.text('Hist√≥rico de Treino', 14, 22);
      doc.setFontSize(12);
      doc.setTextColor(100);
      doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 14, 30);
      
      // Table data
      const sessoes = JSON.parse(localStorage.getItem("sessoes")) || [];
      
      if (sessoes.length === 0) {
        doc.setFontSize(14);
        doc.text('Nenhuma sess√£o salva para exportar.', 14, 45);
        doc.save(`historico_treino_${new Date().toISOString().slice(0,10)}.pdf`);
        return;
      }
      
      // Prepare data for the table
      const tableColumn = ["Data/Hora", "Exerc√≠cio", "Execu√ß√µes", "Repeti√ß√µes", "Carga 1 (kg)", "Carga 2 (kg)"];
      const tableRows = [];
      
      sessoes.forEach(sessao => {
        const sessaoData = [
          new Date(sessao.data).toLocaleString('pt-BR'),
          sessao.exercicio,
          sessao.execucoes.toString(),
          sessao.repeticoes.toString(),
          sessao.carga1 ? sessao.carga1.toString() + ' kg' : '0 kg',
          sessao.carga2 !== null && sessao.carga2 !== undefined ? sessao.carga2.toString() + ' kg' : '-'
        ];
        tableRows.push(sessaoData);
      });
      
      // Add table to PDF
      doc.autoTable({
        head: [tableColumn],
        body: tableRows,
        startY: 40,
        styles: { 
          fontSize: 10,
          cellPadding: 3,
          overflow: 'linebreak',
          lineWidth: 0.1
        },
        headStyles: {
          fillColor: [41, 128, 185],
          textColor: 255,
          fontStyle: 'bold',
          lineWidth: 0.1
        },
        alternateRowStyles: {
          fillColor: [245, 245, 245]
        },
        margin: { top: 40 }
      });
      
      // Save the PDF
      doc.save(`historico_treino_${new Date().toISOString().slice(0,10)}.pdf`);
    }

    function removerSessao(index) {
      if (!confirm('Tem certeza que deseja excluir esta sess√£o?')) return;
      
      const sessoes = JSON.parse(localStorage.getItem("sessoes")) || [];
      if (index >= 0 && index < sessoes.length) {
        sessoes.splice(index, 1);
        localStorage.setItem("sessoes", JSON.stringify(sessoes));
        exibirHistoricoSessoes();
      }
    }
    
    // Inicializa√ß√£o
    atualizarDropdown();
    atualizarLista();
    exibirHistoricoSessoes();
  </script>

</body>
</html>
